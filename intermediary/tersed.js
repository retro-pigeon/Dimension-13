zzfx=(...a)=>zzfxP(zzfxG(...a));zzfxP=(...a)=>{let b=zzfxX.createBufferSource(),c=zzfxX.createBuffer(a.length,a[0].length,zzfxR);a.map((f,e)=>c.getChannelData(e).set(f));b.buffer=c;b.connect(zzfxX.destination);b.start();return b};
zzfxG=(a=1,b=.05,c=220,f=0,e=0,g=.1,k=0,p=1,q=0,u=0,B=0,N=0,X=0,Ua=0,Ha=0,rb=0,E=0,Ia=1,ea=0,Va=0)=>{let C=2*Math.PI,sb=q*=500*C/zzfxR**2,tb=(0<Ha?1:-1)*C/4;b=c*=(1+2*b*Math.random()-b)*C/zzfxR;let Ja=[],O=0,Wa=0,z=0,fa=1,ub=0,vb=0,I=0,ha,Y;f=99+zzfxR*f;ea*=zzfxR;e*=zzfxR;g*=zzfxR;E*=zzfxR;u*=500*C/zzfxR**3;Ha*=C/zzfxR;B*=C/zzfxR;N*=zzfxR;X=zzfxR*X|0;for(Y=f+ea+e+g+E|0;z<Y;Ja[z++]=I)++vb%(100*rb|0)||(I=k?1<k?2<k?3<k?Math.sin((O%C)**3):Math.max(Math.min(Math.tan(O),1),-1):1-(2*O/C%2+2)%2:1-4*Math.abs(Math.round(O/
C)-O/C):Math.sin(O),I=(X?1-Va+Va*Math.sin(2*Math.PI*z/X):1)*(0<I?1:-1)*Math.abs(I)**p*a*zzfxV*(z<f?z/f:z<f+ea?1-(z-f)/ea*(1-Ia):z<f+ea+e?Ia:z<Y-E?(Y-z-E)/g*Ia:0),I=E?I/2+(E>z?0:(z<Y-E?1:(Y-z)/E)*Ja[z-E|0]/2):I),ha=(c+=q+=u)*Math.sin(Wa*Ha-tb),O+=ha-ha*Ua*(1-1E9*(Math.sin(z)+1)%2),Wa+=ha-ha*Ua*(1-1E9*(Math.sin(z)**2+1)%2),fa&&++fa>N&&(c+=B,b+=B,fa=0),!X||++ub%X||(c=b,q=sb,fa=fa||1);return Ja};zzfxV=.5;zzfxR=44100;zzfxX=new (window.AudioContext||webkitAudioContext);
var aa=[0,0,-150,-86,0,-75,-86,0,75,0,0,150,86,0,75,86,0,-75,0,50,-96,-55,50,-48,-55,50,48,0,50,96,55,50,48,55,50,-48,0,-50,-96,-55,-50,-48,-55,-50,48,0,-50,96,55,-50,48,55,-50,-48],ba=[4,9,3,2,7,1,5,10,4,3,8,2,1,6,0,0,11,5,8,10,6,15,4,3,1,14,2,4,17,5,2,15,3,12,1,0,5,12,0,12,16,14,4,10,9,2,8,7,5,11,10,3,9,8,1,7,6,0,6,11,6,7,8,8,9,10,10,11,6,15,16,4,1,13,14,4,16,17,2,14,15,12,13,1,5,17,12,14,13,12,12,17,16,16,15,14],ca=[["#80D08C",32]],da=[-91,208,125,-91,338,-4,-91,78,-4,-206,208,-257,0,208,154,0,
367,-4,-112,288,75,-112,129,75,-124,295,-67,-124,120,-67,0,50,-4,-202,212,-397,0,318,104,-154,208,-4,0,87,-100,0,99,104,0,328,-100,-107,296,-582,-88,220,-631,-107,144,-582,0,220,-658,0,115,-611,0,325,-611,-150,345,-261,0,395,-312,0,28,-312,-188,78,-261],ia=[12,1,6,12,0,4,0,13,7,1,13,6,8,9,13,13,2,7,2,14,10,11,17,18,0,15,4,2,15,7,24,17,23,1,16,8,18,21,19,18,22,20,11,19,26,25,19,21,14,26,25,3,26,9,16,23,8,3,23,11,12,5,1,12,6,0,0,6,13,1,8,13,8,3,9,13,9,2,2,9,14,11,23,17,0,7,15,2,10,15,24,22,17,1,5,16,
18,20,21,18,17,22,11,18,19,25,26,19,14,9,26,3,11,26,16,24,23,3,8,23],ja=[["#442424",40]],ka=[-328,194,-200,-326,234,-200,-324,194,-160,-322,234,-160,-167,165,-168,-161,223,-168,-172,165,-221,-166,223,-222,-442,195,-185,-450,227,-184,-439,195,-153,-446,227,-152,-569,143,-170,-589,161,-168,-567,143,-144,-586,161,-142,-627,0,-158,-640,5,-157,-625,0,-144,-639,5,-143],la=[5,2,4,3,10,2,2,6,4,5,1,3,0,7,6,11,14,10,1,8,9,2,8,0,1,11,3,13,19,15,9,12,13,10,12,8,9,15,11,14,19,18,12,17,13,14,16,12,5,3,2,3,11,10,
2,0,6,5,7,1,0,1,7,11,15,14,1,0,8,2,10,8,1,9,11,13,17,19,9,8,12,10,14,12,9,13,15,14,15,19,12,16,17,14,18,16],ma=[["#5d5775",32]],na=[0,-26,-200,84,-26,-97,226,-26,0,84,-26,97,0,-26,200,-84,-26,97,-173,-26,0,-84,-26,-97,0,1015,0],oa=[0,8,1,1,8,2,2,8,3,3,8,4,4,8,5,5,8,6,6,8,7,7,8,0],pa=[["#247BA0",8]],qa=[-100,0,100,100,0,100,-100,0,-100,100,0,-100],ra=[1,2,0,1,3,2],sa=[["#70C1B3",2]],ta=[-70,0,70,-100,0,0,-100,23,0,-70,23,70,0,0,0,0,23,0,-35,0,35,-50,0,0,-50,23,0,-35,23,35,-82,0,82,-116,0,0,-116,13,
0,-82,13,82],ua=[5,3,9,3,4,5,3,6,0,5,1,2,8,6,9,1,8,2,2,9,3,1,12,11,0,13,3,3,12,2,13,11,12,8,2,5,9,8,5,3,0,4,3,9,6,5,4,1,8,7,6,1,7,8,2,8,9,1,2,12,0,10,13,3,13,12,13,10,11],va=[["#778899",23]],wa=[0,0,-100,-86,0,50,86,0,50,0,0,100,86,0,-50,-86,0,-50],xa=[4,5,3,1,2,0],ya=[["#FFFFFF",2]],za=[0,0,-100,-28,0,-95,-54,0,-84,-75,0,-65,-90,0,-41,-98,0,-14,-98,0,14,-90,0,41,-75,0,65,-54,0,84,-28,0,95,0,0,99,28,0,95,54,0,84,75,0,65,90,0,41,98,0,14,98,0,-14,90,0,-41,75,0,-65,54,0,-84,28,0,-95],Aa=[2,21,0,0,1,
2,2,20,21,5,18,3,3,4,5,5,17,18,18,19,3,8,15,6,6,7,8,8,14,15,15,16,6,11,13,9,9,10,11,11,12,13],Ba=[["#E87C00",3],["#E85F5A",4],["#E81F67",4],["#E700B5",3]],Ca=[-92,-2,-38,12,197,99,-83,2,-55,-6,202,99,-21,164,97,-53,131,84,-79,97,60,-95,64,29,-99,31,-4,-40,168,91,-68,135,72,-89,102,44,-99,68,11,-97,35,-23],Da=[0,13,2,7,11,12,5,9,10,0,8,13,7,6,11,5,4,9,4,3,9,8,12,13,6,10,11,4,1,3,8,7,12,6,5,10],Ea=[["#73E1E733",6],["#50BEEF22",6]],Fa=[0,1950,0,-578,2156,0,-408,2156,408,0,2156,0,-460,1806,460,-650,1806,
0,0,1806,0,-358,2446,367,-506,2480,0,0,2337,0,-151,2718,0,-107,2685,132,0,2608,0,0,2718,0,-1237,1973,0,-1236,1930,0,-1240,1950,0,-874,1930,874,-875,1973,875,-877,1950,877,-1374,0,0,-971,0,971],Ga=[3,7,9,1,9,8,1,7,2,9,11,12,9,10,8,8,11,7,10,12,13,12,11,13,11,10,13,5,4,6,4,20,5,3,2,7,1,3,9,1,8,7,9,7,11,9,12,10,8,10,11,4,21,20,16,3,1,19,6,4,19,2,3,16,5,6,15,4,5,14,15,16,17,18,19,15,18,17,18,1,2,1,14,16,16,0,3,4,17,19,19,0,6,3,0,19,19,18,2,6,0,16,16,15,5,15,17,4,15,14,18,18,14,1],Ka=[["#10E70022",18],
["#6FB2BE",20]],La=[-70,0,70,0,0,100,0,0,0,-56,-16,56,0,-16,80,0,-16,44,-31,-16,31,0,-9,44,-31,-9,31,0,-9,0],Ma=[7,9,8,4,6,3,0,4,3,5,8,6,4,5,6,0,1,4,5,7,8],Na=[["#E7000E",1],["#E7B500",6]],Oa=[0,-70,-100,86,-70,50,-86,-70,50,0,70,0],Pa=[0,3,1,0,1,2,1,3,2,2,3,0],Qa=[-70,-100,-70,-70,100,-70,-70,-70,-100,-70,70,-100,-100,100,-100,-100,-100,-100,0,-100,-100,0,100,-100,0,-100,-70,0,100,-70,0,-70,-100,0,70,-100],Ra=[0,6,8,2,4,3,3,7,11,2,6,5,1,7,4,0,5,6,2,5,4,3,4,7,2,10,6,1,9,7],Sa=[["#006699",10]],Ta=
[-98,0,89,-1,0,110,-100,0,-100,0,0,-100,-175,0,268,-78,0,292,-432,0,425,-350,0,483,-125,0,532,-25,0,535,-544,0,858,-447,0,882,-227,0,906,-130,0,932],Xa=[0,3,2,0,5,1,4,7,5,5,8,4,7,10,11,8,13,12,0,1,3,0,4,5,4,6,7,5,9,8,7,6,10,8,9,13],Ya=[26,0,123,25,0,36,26,0,11,118,0,-15,85,0,-113,-65,0,-130,-122,0,-53,-65,0,-18,-32,0,-73,36,0,-68,43,0,-42,-34,0,-19,-36,0,34,26,0,64,-39,0,59,-44,0,116],Za=[15,13,0,10,9,4,15,14,13,2,1,12,12,11,10,2,12,10,4,3,2,6,5,4,8,7,6,8,6,4,4,2,10,9,8,4],$a=[["#66ccff",12]];
const ab=()=>{let a=rand(50),b=rand(50);if(!d(a,b)&&10<Math.hypot(a,b))return ab();const c=h(aa,ba,ca,l(a,0,b),l(Math.PI/2,0,0),l(.25,.25,.25));m.push(c);const f=h(wa,xa,ya,l(a,30,b),l(Math.PI/2,0,0),l(2,2,2));m.push(f);return e=>{c.position.y=.25*Math.sin(timeStamp/1E3)+1;c.rotation.y+=e;f.rotation.y+=e*Math.random();!c.h&&10>distanceTo(c.position,n.position)&&Math.random()<e&&bb(r(c.position),l(rand(.005),rand(.025),rand(.005)),"#80D08C");if(!c.h&&3>distanceTo(c.position,n.position)){c.h=!0;t++;
zzfx(...[,,539,0,.04,.29,1,1.92,,,567,.02,.02,,,,.04]);7==t&&cb("You found all gems, return to the teleporter!");5==t&&(cb("Is it a bird? Is it a plane? It's a UFO",1.2),v.push(db()),v.push(db()),v.push(db()),v.push(db()),v.push(db()));if(1==t)for(cb("By the way, watch out for the Arachnoids",1.2),e=0;70>e;e++){var g=rand(100),k=rand(100);d(g,k)&&10<distanceTo(l(w,w,w),l(g,0,k))&&eb.push(fb(l(g,0,k)))}if(3==t)for(cb("The spirits are watching...",1.2),e=0;50>e;e++)g=rand(100),k=rand(100),d(g,k)&&10<
distanceTo(l(w,w,w),l(g,0,k))&&eb.push(fb(l(g,0,k),1))}}},gb=a=>{const b=h(La,Ma,Na,a,w,l(1,-1,1),1,1);m.push(b);console.log(`Landmine: ${a.x} ${a.y} ${a.z}`);return()=>{2.5>distanceTo(n.position,b.position)&&(console.log("stepped on landmine"),zzfx(...[2,,45,.01,.27,.49,3,1.6,-9,,,,,1.3,.4,.8,.2,.41,.15]),x=-.1)}};let hb=[];var d=(a,b)=>{for(const c of hb){let f=0;for(let e=0;e<c.length;e+=4){let g=c[e],k=c[e+1],p=c[e+2],q=c[e+3];b<k!==b<q&&a<g+(b-k)/(q-k)*(p-g)&&(f+=1)}if(0!==f%2)return!0}return!1};
function ib(){function a(e,g){return 0<=e&&0<=g&&50>e&&50>g}function b(e,g){c[g][e]=0;f.sort(()=>Math.random()-.5).forEach(([k,p])=>{const [q,u]=[e+k,g+p],[B,N]=[e+k/2,g+p/2];a(q,u)&&c[u][q]&&(c[N][B]=0,b(q,u))})}const c=Array.from({length:50},()=>Array(50).fill(1)),f=[[0,2],[2,0],[0,-2],[-2,0]];b(1,1);for(let e=-2;2>=e;e++)for(let g=-2;2>=g;g++)a(25+g,25+e)&&(c[25+e][25+g]=0);c[0][1]=c[49][48]=0;return c}
const jb=()=>{var a=y([]),b=ib().flat().map(c=>.2>Math.random()?0:c);for(let c=0;2500>c;c++){const f=c%50*4-100+3,e=4*Math.floor(c/50)-100+3;if(b[c])a.g.push(h(na,oa,pa,l(f,0,e),l(.2-.4*Math.random(),Math.random()*Math.PI*2,0),l(1,1,1)));else{let g=.2*b[c-50],k=-.2*b[c+50],p=.2*b[c-1],q=-.2*b[c+1];hb.push([f-2+p,e-2+g,f-2+p,e+2+k,f-2+p,e+2+k,f+2+q,e+2+k,f+2+q,e+2+k,f+2+q,e-2+g,f+2+q,e-2+g,f-2+p,e-2+g])}}m.push(a)};messages=[];
showMessage=(a,b,c,f=50,e=1E6,g=0)=>messages.push({text:a,x:b,y:c,size:f,duration:e,delay:g,counter:0,S:Math.max(random(3),1)});
updateMessages=()=>{messages.forEach((a,b)=>{0<a.delay--||(a.counter+=1,A.font=`${a.size}px ${"serif"}`,A.textAlign="center",A.textBaseline="middle",100>a.duration&&(a.y-=a.S),20>=a.counter&&(A.fillStyle=`rgba(255,255,255 ,${a.counter/20})`),20<a.counter&&a.counter<=a.duration-60&&(A.fillStyle="white"),a.counter>a.duration-60&&(A.fillStyle=`rgba(255,255,255,${-(a.counter-a.duration)/60})`),A.fillText(a.text,a.x,a.y),a.counter>a.duration&&messages.splice(b,1))})};
let kb=[],mb=()=>{let a=l(Math.cos(timeStamp/1E3)/10+.025-Math.random()/20,0,Math.sin(timeStamp/1E3)/10+.025-Math.random()/20),b=[];kb.forEach((c,f)=>{c.i.position=D(c.i.position,c.s);c.i.position=D(c.i.position,multiplyBy(a,F));c.i.rotation=D(c.i.rotation,c.N);c.counter-=F/20;c.i.opacity=Math.max(c.counter/c.K,0);0>=c.counter?(c.i.h=!0,b.push(f)):c.I&&(c.s.y-=.02*F)});b.reverse().forEach(c=>{lb.g.splice(c,1);kb.splice(c,1)})};
const bb=(a,b,c="#FFFFFF",f=l(.005-.01*Math.random(),.05-.01*Math.random(),.005-.01*Math.random()),e=1,g=!1,k=.2)=>{a=h(Oa,Pa,[[c,4]],a,w,l(k,k,k));lb.g.push(a);kb.push({i:a,s:b,counter:e,N:f,K:e,I:g})},nb=a=>{let b=y([h(Ya,Za,$a,w,l(Math.PI/2,0,0),l(.2,.2,.2)),h(Qa,Ra,Sa,w,w,l(.4,.4,.4),1,1)]);b.position=a;m.push(b);return c=>{b.g[0].rotation.y=angleBetween(b.position,n.position);b.g[1].rotation.x+=c/5;b.g[1].rotation.z+=c/5;b.position.y=1.5+Math.sin(timeStamp/500)/2;!b.h&&1>distanceTo(n.position,
b.position)&&(G=.999,H=1,b.h=!0,b.g[0].h=!0,b.g[1].h=!0);!b.h&&10>distanceTo(n.position,b.position)&&Math.random()<c&&(bb(r(b.position),l(rand(.05),.1,rand(.05)),"#66ccff",w,w,1),zzfx(...[,,105,.06,.36,.001,1,2.3,,,10,,.06,,,,,.96,.47,1]))}};var J=[],K=[],ob=[],pb=0;
const fb=(a,b=!1)=>{let c=eb.length,f=0,e=3;J.push(a);K.push(1+Math.random()/2);ob.push(1);let g=y([h(da,ia,ja,l(0,0,.8),w,l(.25,.25,.25),1),h(ka,la,ma,l(0,0,0),w,l(.25,.25,.25),1),h(ka,la,ma,l(0,0,.4),w,l(.25,.25,.25),1),h(ka,la,ma,l(0,0,.8),w,l(.25,.25,.25),1),h(ka,la,ma,l(0,0,1.2),w,l(.25,.25,.25),1)]);g.scale=l(K[c],K[c],K[c]);g.position=a;b||m.push(g);return k=>{if(0>=K[c])g.h=!0,ob[c]=0;else if(e-=k,f+=k,g.g[1].rotation=l(0,.05*Math.cos(f),.15*Math.sin(f)),g.g[2].rotation=l(0,.05*Math.sin(f),
.15*Math.cos(f)),g.g[3].rotation=l(0,.05*Math.cos(f),.15*Math.sin(f)),g.g[4].rotation=l(0,.05*Math.sin(f),.15*Math.cos(f)),g.rotation.y=Math.atan2(n.position.x-g.position.x,n.position.z-g.position.z),!(4.358>=distanceTo(l(w,w,w),n.position))){if(3<distanceTo(g.position,n.position)&&5<distanceTo(l(w,w,w),g.position)&&10>=distanceTo(g.position,n.position)){var p=r(g.position);p.x+=Math.sin(g.rotation.y)*k;p.z+=Math.cos(g.rotation.y)*k;(b||d(p.x,p.z))&&5<distanceTo(l(w,w,w),g.position)&&(g.position=
p)}.1<pb&&(p=r(g.position),p.x-=Math.sin(g.rotation.y)*k*pb*5,p.z-=Math.cos(g.rotation.y)*k*pb*5,zzfx(...[,,73,,.02,.07,4,3.6,,,,,.03,.5,14,.8,.01,.62]),d(p.x,p.z)&&5<distanceTo(l(w,w,w),g.position)&&(g.position=p),pb-=k/10);4>distanceTo(g.position,n.position)&&0>=e&&(x-=.05,e=3,zzfx(...[,,100,,.04,,4,5,,,,,,1.4,,.1,,.89,,,-2247]),qb());if(b&&10>=distanceTo(g.position,n.position))for(p=0;1>p;p++)bb(D(g.position,l(0,1.8,0)),l(rand(.1),rand(.1),rand(.1)),"#FFFFFF",w,1,!0,.3);10>=distanceTo(g.position,
n.position)&&Math.random()<k/20&&zzfx(...[,,770,.3,,.22,2,4.6,-87,,48,.52,.06,,,,,.54,.14,.13,-554]);J[c]=g.position}}},db=()=>{const a=h(Fa,Ga,Ka,void 0,void 0,l(.56,.56,.56),1,1);a.position=l(100-200*Math.random(),void 0,100-200*Math.random());m.push(a);let b=l(100-200*Math.random(),void 0,100-200*Math.random());return c=>{var f=substract(b,a.position);1>length(f)?b=l(100-200*Math.random(),void 0,100-200*Math.random()):(f=normalize(f),f=multiplyBy(f,1*c),a.position=D(a.position,f));6>distanceTo(n.position,
a.position)&&(x-=1*c)}};function qb(){const a=navigator.getGamepads()[0];a?a.R?a.R.U("dual-rumble",{V:0,duration:1,Y:0,W:.1}).catch(b=>console.log("Vibration error:",b)):console.log("Vibration actuator not available on this gamepad."):console.log("Gamepad with index 0 not found.")}
const wb=(a,b,c,f=0,e=0)=>{var g=b.length,k=[],p=[];for(var q of b)k.push(a[3*q],a[3*q+1],a[3*q+2]);for(q=0;q<c.length;q+=4)p.push(c[q],c[q+1],c[q+2],c[q+3],c[q],c[q+1],c[q+2],c[q+3],c[q],c[q+1],c[q+2],c[q+3]);f&&(k=[...k,...k.map((u,B)=>B%3?u:-u)],p=[...p,...p],g*=2);e&&(k=[...k,...k.map((u,B)=>2==B%3?-u:u)],k=[...k,...k.map((u,B,N)=>1==B%3?u:2==B%3?N[B-2]:N[B+2])],p=[...p,...p,...p,...p],g*=4);f=CreateAndBindBufferData(k);p=CreateAndBindBufferData(p);k=CreateAndBindBufferData(getNormals(k));L.bindBuffer(L.ARRAY_BUFFER,
null);return{X:a,indices:b,T:c,J:g,P:f,G:p,M:k}};getNormals=a=>{let b=[];for(let c=0;c<a.length;c+=9){let f=cross(normalize(l(a[c+3]-a[c],a[c+3+1]-a[c+1],a[c+3+2]-a[c+2])),normalize(l(a[c+6]-a[c],a[c+6+1]-a[c+1],a[c+6+2]-a[c+2])));b.push(f.x,f.y,f.z,f.x,f.y,f.z,f.x,f.y,f.z)}return b};CreateAndBindBufferData=a=>{const b=L.createBuffer();L.bindBuffer(L.ARRAY_BUFFER,b);L.bufferData(L.ARRAY_BUFFER,new Float32Array(a),L.STATIC_DRAW);return b};
const y=a=>({L:!0,position:l(0,0,0),rotation:l(0,0,0),scale:l(1,1,1),g:a}),l=(a=0,b=0,c=0)=>({x:a,y:b,z:c}),r=a=>l(a.x,a.y,a.z),D=(a,b)=>l(a.x+b.x,a.y+b.y,a.z+b.z);substract=(a,b)=>l(a.x-b.x,a.y-b.y,a.z-b.z);multiplyBy=(a,b)=>l(a.x*b,a.y*b,a.z*b);divide=(a,b)=>l(a.x/b,a.y/b,a.z/b);length=a=>Math.hypot(a.x,a.y,a.z);cross=(a,b)=>l(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x);dot=(a,b)=>a.x*b.x+a.y*b.y+a.z*b.z;normalize=a=>divide(a,length(a));
rotX=(a,b)=>l(a.x,a.y*Math.cos(b)-a.z*Math.sin(b),a.y*Math.sin(b)+a.z*Math.cos(b));rotY=(a,b)=>l(a.x*Math.cos(b)-a.z*Math.sin(b),a.y,a.x*Math.sin(b)+a.z*Math.cos(b));rotZ=(a,b)=>l(a.x*Math.cos(b)-a.y*Math.sin(b),a.x*Math.sin(b)+a.y*Math.cos(b),a.z);distanceTo=(a,b)=>length(substract(a,b));translate=a=>new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,a.x,a.y,a.z,1]);scale=a=>new Float32Array([a.x,0,0,0,0,a.y,0,0,0,0,a.z,0,0,0,0,1]);
rotateX=a=>{const b=Math.sin(a);a=Math.cos(a);return new Float32Array([1,0,0,0,0,a,b,0,0,-b,a,0,0,0,0,1])};rotateY=a=>{const b=Math.sin(a);a=Math.cos(a);return new Float32Array([a,0,-b,0,0,1,0,0,b,0,a,0,0,0,0,1])};rotateZ=a=>{const b=Math.sin(a);a=Math.cos(a);return new Float32Array([a,b,0,0,-b,a,0,0,0,0,1,0,0,0,0,1])};perspective=(a,b,c,f)=>{a=1/Math.tan(a/2);const e=1/(c-f);return new Float32Array([a/b,0,0,0,0,a,0,0,0,0,(f+c)*e,-1,0,0,2*f*c*e,0])};
lookAt=(a,b,c)=>{b=normalize(substract(a,b));c=normalize(cross(c,b));const f=cross(b,c);return new Float32Array([c.x,f.x,b.x,0,c.y,f.y,b.y,0,c.z,f.z,b.z,0,-dot(c,a),-dot(f,a),-dot(b,a),1])};multiply=(a,b)=>{const c=new Float32Array(16);for(let f=0;4>f;f++)for(let e=0;4>e;e++){let g=0;for(let k=0;4>k;k++)g+=a[4*f+k]*b[4*k+e];c[4*f+e]=g}return c};transform=(a,b,c)=>multiply(multiply(scale(c),multiply(multiply(rotateX(b.x),rotateY(b.y)),rotateZ(b.z))),translate(a));lerp=(a,b,c)=>a+(b-a)*c;
random=(a=1)=>Math.random()*a;randomBetween=a=>a-Math.random()*a*2;lerpColors=(a,b,c)=>Color(a.r+(b.r-a.r)*c,a.D+(b.D-a.D)*c,a.b+(b.b-a.b)*c);easeInOutCubic=a=>.5>a?4*a*a*a:1-Math.pow(-2*a+2,3)/2;angleBetween=(a,b)=>Math.atan2(a.x-b.x,a.z-b.z);abs=Math.abs;rand=a=>a-2*a*Math.random();
const h=(a,b,c,f=l(),e=l(),g=l(1,1,1),k=0,p=0)=>{let q=[];for(let u of c)for(c=0;c<u[1];c++)q.push(...xb(u[0]));return{m:wb(a.map(u=>u/100),b,q,k,p),position:f,rotation:e,scale:g}},xb=a=>[parseInt(a.slice(1,3),16)/255,parseInt(a.slice(3,5),16)/255,parseInt(a.slice(5,7),16)/255,parseInt(a.slice(7,9),16)/255||1];var yb=15;
const Bb=(a,b,c=1,f=null)=>{c&&(L.clear(L.COLOR_BUFFER_BIT|L.DEPTH_BUFFER_BIT),L.uniform1f(zb,yb),L.viewport(0,0,L.canvas.width,L.canvas.height),L.uniformMatrix4fv(Ab,!1,lookAt(b.position,b.target,b.O)));for(const e of a)e.h||(e.L?Bb(e.g,b,0,transform(e.position,e.rotation,e.scale)):(L.uniform1f(uOpacityLocation,e.opacity||1),bindBufferAttribute(e.m.P,M.A),bindBufferAttribute(e.m.G,M.v,4),bindBufferAttribute(e.m.M,M.u),f?L.uniformMatrix4fv(Cb,!1,multiply(transform(e.position,e.rotation,e.scale),f)):
L.uniformMatrix4fv(Cb,!1,transform(e.position,e.rotation,e.scale)),L.drawArrays(L.TRIANGLES,0,e.m.J),L.bindBuffer(L.ARRAY_BUFFER,null)))};bindBufferAttribute=(a,b,c=3)=>{L.bindBuffer(L.ARRAY_BUFFER,a);L.vertexAttribPointer(b,c,L.FLOAT,!1,0,0);L.enableVertexAttribArray(b)};var zb;
const Eb=()=>{L.clearColor(.2,.094,.196,1);L.enable(L.DEPTH_TEST);L.clearDepth(1);L.depthFunc(L.LEQUAL);L.enable(L.BLEND);L.blendFunc(L.SRC_ALPHA,L.ONE_MINUS_SRC_ALPHA);L.disable(L.CULL_FACE);M=L.createProgram();compileShader("#version 300 es\nprecision mediump float;uniform mat4 uMeshMatrix,uCameraMatrix,uProjectionMatrix;in vec3 B,D;in vec4 C;out vec4 A,E,Z;out vec3 F;void main(){gl_Position=uProjectionMatrix*uCameraMatrix*uMeshMatrix*vec4(B,1);E=C;A=gl_Position;Z=uMeshMatrix*vec4(B,1.0);}",L.VERTEX_SHADER,
M);compileShader("#version 300 es\nprecision mediump float;in vec4 A;in vec3 F;in vec4 Z,E;uniform float G,O;out vec4 fragColor;void main(){float P=max(min(1.-A.z/G,1.),.05)+.05-fract(sin(dot(A.xy.xy,vec2(12.9898,78.233)))*43758.5453123)*.1;P*=P;if(Z.y>10.1)P=1.;fragColor=mix(vec4(.2,.094,.196,1.0),E,P);fragColor.w*=O;}\n",L.FRAGMENT_SHADER,M);L.linkProgram(M);L.useProgram(M);Cb=L.getUniformLocation(M,"uMeshMatrix");Ab=L.getUniformLocation(M,"uCameraMatrix");Db=L.getUniformLocation(M,"uProjectionMatrix");
const a=(new Float32Array(60)).fill(0).map((b,c)=>1==c%3?0:40-80*Math.random());L.uniform3fv(L.getUniformLocation(M,"uLightPosition"),a);zb=L.getUniformLocation(M,"G");L.uniform1f(zb,15);uOpacityLocation=L.getUniformLocation(M,"O");L.uniform1f(uOpacityLocation,1);L.uniformMatrix4fv(Db,!1,perspective(n.C,n.o,n.F,n.B));M.A=L.getAttribLocation(M,"B");L.enableVertexAttribArray(M.A);M.v=L.getAttribLocation(M,"C");L.enableVertexAttribArray(M.v);M.u=L.getAttribLocation(M,"D");L.enableVertexAttribArray(M.u)};
compileShader=(a,b,c)=>{b=L.createShader(b);L.shaderSource(b,a);L.compileShader(b);L.getShaderParameter(b,L.COMPILE_STATUS)?L.attachShader(c,b):console.error("Shader compilation error:",L.getShaderInfoLog(b))};initialiseGameOverScene=()=>{messages=[];showMessage("\ud835\udd72\ud835\udd8d\ud835\udd94\ud835\udd98\ud835\udd99 \ud835\udd86\ud835\udd8c\ud835\udd86\ud835\udd8e\ud835\udd93",P,Q-15,30);showMessage("Press enter to reincarnate!",P,Q+25,15)};
updateGameOverScene=()=>{console.log(messages);A.clearRect(0,0,R,S);updateMessages();Fb&&window.location.reload()};
const Gb=()=>{messages=[];showMessage("\ud835\udd6f\ud835\udd8e\ud835\udd92\ud835\udd8a\ud835\udd93\ud835\udd98\ud835\udd8e\ud835\udd94\ud835\udd93",P,.5*Q,.4*Q,1E7,30);showMessage("\ud835\udd7f\ud835\udd8d\ud835\udd8e\ud835\udd97\ud835\udd99\ud835\udd8a\ud835\udd8a\ud835\udd93",P,.85*Q,.4*Q,1E7,35);showMessage("Escape the thirteenth dimension",P,1.2*Q,.2*Q,1E7,60)},Jb=()=>{A.fillStyle="black";A.fillRect(0,0,R,S);updateMessages();(Fb||Hb||Ib)&&showScene(playScene(),!0)};document.onclick=()=>{document.documentElement.requestPointerLock()};
var Kb=Math.random()*Math.PI*2,Lb,T=1,Mb=[],t=0,x=1,Nb=.2,Ob=[],Pb=[],Qb,m,lb,Rb,Sb,Tb=0,Ub,eb=[],Vb,Wb=y([]),Xb=.99,U=0,Yb=0,v=[],w,H=1,G=.999,Hb,Ib,Zb=-1,V=0,W="\ud83d\udca9 \u2764\ufe0f \ud83d\udc41\ufe0f \ud83d\udee1\ufe0f \ud83e\udebd \u23f3 \u26a1 \u2694\ufe0f".split(" "),$b=-1;
const dc=()=>{messages=[];Vb=y([]);for(var a=0;10>a;a++)Vb.g.push(h(Ca,Da,Ea,l(0,0,0),l(0,a/10*Math.PI*2,0),l(4.5,4.5,4.5)));m=[h(qa,ra,sa,w,w,l(1E3,1E3,1E3)),h(ta,ua,va,l(0,.1,0),l(0,Math.PI/4,0),l(4.5,1,4.5),1,1),y([h(za,Aa,Ba,l(0,90,0),w,l(30,30,30))])];n={position:l(0,1.69,0),direction:l(0,0,1),H:1.4,j:0,pitch:0,target:l(0,0,0),C:Math.PI/2,o:R/S,F:.1,B:200,O:l(0,1,0)};setInterval(()=>{if(4.358<distanceTo(l(w,w,w),n.position)){if(12<=U){Tb=.5;ac=2;v.push(db());for(let f=0;f<U*U/10;f++){let e=100-
200*Math.random(),g=100-200*Math.random();d(e,g)&&1<distanceTo(l(w,w,w),l(e,0,g))&&10<distanceTo(n.position,l(e,0,g))&&eb.push(fb(l(e,0,g),.3>Math.random()))}zzfx(...[2.1,0,1E6,,.5,0,3,2.6,,,,,,,,.5])}else ac=1;zzfx(...[2,.8,100,,,,,1.5,,.3,-99,.1,1.63,,,.11,.22]);Yb=1;U++;13==U&&cb("Run back")}},950);setInterval(()=>{zzfx(...[.4,.1,10,,.07,.26,,5,,,-100,.01,,,,,.25,.73,,,-1473]);Nb=.8;x+=.05},1200);Eb();document.addEventListener("click",bc);document.addEventListener("mousemove",cc);jb();for(a=0;100>
a;a++){var b=100-200*Math.random(),c=100-200*Math.random();d(b,c)&&10<distanceTo(l(w,w,w),l(b,0,c))&&Pb.push(gb(l(b,0,c)))}for(a=0;7>a;a++)Mb.push(ab());for(a=0;1E3>a;a++)Wb.g.push(h(wa,xa,ya,l(rand(150),30,rand(150)),w,l(.5,.5,.5)));for(a=0;200>a;a++)b=Math.random()/10+.1,m.push(h(Ta,Xa,[["#382847",12]],l(rand(100),0,rand(100)),l(-Math.PI/2,rand(Math.PI),0),l(b,b,b),1));m.push(Wb);m.push(Vb);lb=y([]);m.push(lb);Ob=[nb(l(0,2,0))];for(a=0;100>a;a++)b=100-200*Math.random(),c=100-200*Math.random(),d(b,
c)&&10<distanceTo(l(w,w,w),l(b,0,c))&&Ob.push(nb(l(b,0,c)))},gc=a=>{yb=2*Math.sin(timeStamp/200)+10+.4*Math.random()-.8;V-=a/100;if(0<V)switch(Zb){case 0:V=0;break;case 1:x+=.5;break;case 2:yb=100;break;case 5:U=13;break;case 6:T=1}0>V&&(V=1E3,Zb=-1);A.globalAlpha=1;H-=a/20;H=Math.max(H,0);Rb++;Nb*=Nb;Tb-=a/10;Math.random()<a/1E3&&zzfx(...[1.6,,182,,.05,.25,1,3.5,,7,,,.09,.4,,.1,.04,.81,.31,.03,-1260]);m[2].rotation.x+=a/40;Vb.rotation.y+=a/40;eb.forEach(b=>b(a));Mb.forEach(b=>b(a));v.forEach(b=>
b(a));Pb.forEach(b=>b(a));Ob.forEach(b=>b(a));A.drawImage(ec,0,0);A.fillStyle="white";A.font=`${15*(1+Yb)}px monospace`;Yb-=a;Yb*=Yb;A.fillText(U,10,20);A.fillRect(P-.5,Q-3.5,.5,7);A.fillRect(P-3.5,Q-.5,7,.5);A.fillStyle="#E37E90";A.fillRect(R/4-10,10,P*Math.max(Math.min(1,x),0),5);A.font=`${15*(1+Nb)}px sans-serif`;A.fillText("\u2764\ufe0f",R/4-10,15);A.fillStyle="#E8C165";A.fillRect(R/4-10,25,P*Math.max(Math.min(1,T),0),5);A.font="15px sans-serif";A.fillText("\u26a1",R/4-10,30);A.strokeStyle="#BFDDE722";
A.lineWidth=(P>>1)*Xb;A.beginPath();A.arc(P,1.5*S,P,0,Xb*Math.PI+Math.PI);A.stroke();A.fillStyle="#FF000022";0<Tb&&A.fillRect(0,0,R,S);A.fillStyle="#FFFFFF";A.fillText(W[Zb]||"\ud83d\udeab",10,S-10);A.fillStyle="#80D08C";A.fillText("\u2b21\u2b21\u2b21\u2b21\u2b21\u2b21\u2b21".replace(/\u2b21/g,(b,c)=>c<t?"\u2b22":b),R-40,10);Kb+=H*H*a*Math.random()*5;for(let [b,c]of W.entries())A.strokeStyle=b&1?"#886CDB":"#9880E0",(Kb+((b+W.length+1)*Math.PI*2/W.length+Math.PI/2))%(2*Math.PI)<2*Math.PI/W.length&&
.01<=H&&($b=b),A.strokeStyle,A.lineWidth=.7*Q,A.beginPath(),A.arc(P,Q+15,Q/2*.7*G,2*Math.PI/W.length*b+Kb,2*Math.PI/W.length*(b+1)+Kb),A.stroke(),.01<G&&A.fillText(c,P+.6*Q*G*Math.cos(2*Math.PI/W.length*(.5+b)+Kb),Q+.6*Q*G*Math.sin(2*Math.PI/W.length*(.5+b)+Kb)+15);.01>H&&-1==Zb&&-1!=$b&&(Zb=$b,V=1,$b=-1);.01>H&&(G*=G);Xb*=Math.pow(Xb,60*a);1<x&&(x=1);4.358>distanceTo(l(w,w,w),n.position)&&(U=0);6<t&&showScene(winScene(),!0);Wb.rotation.y+=a/100;updateMessages();0>x&&showScene(gameOverScene(),!0);
3==Zb&&0<V&&(x=1);mb();Sb=Hb;fc(a);Bb(m,n)};var hc=0;
const fc=a=>{hc-=a/10;let b=l(0,0,0);ic?(0>=hc&&(zzfx(...[2.3,,201,,,.002,,4.5,,2,,,,,,,,.98,,,178]),hc=jc?.3:.5),b=l(0,0,1+(jc&&0<T))):kc?b=l(0,0,-2/3):lc?b=l(2/3,0,0):mc?b=l(-2/3,0,0):Ib||Qb&&!(.1>Math.abs(Qb[1]))||(T=Math.min(T+a/50,1));Qb&&(n.j+=1*Qb[0]*a,b.z=-Qb[1]*(1+Ib));Ub&&(n.j+=Ub[0]/2*a,n.pitch-=Ub[1]/2*a);0==Sb&&1==Hb&&bc();if(Ib||jc)T-=a/100;Lb=D(n.position,multiplyBy(rotY(b,n.j),n.H*a));d(Lb.x,Lb.z)&&(n.position=Lb);n.direction=D(rotY(l(0,0,1),n.j),l(0,n.pitch,0));n.target=D(n.position,
n.direction)},cc=a=>{n.j+=a.movementX/500;n.pitch-=a.movementY/500},bc=()=>{if(!(0>T)){document.documentElement.requestPointerLock();var a=n;let c=substract(a.position,a.target);for(index in J){var b=normalize(substract(a.position,J[index]));b=substract(c,b);b=abs(b.x)+abs(b.y)+abs(b.z);if(5>distanceTo(a.position,J[index])&&3>b&&ob[index]){for(a=0;20>a;a++)bb(r(J[index]),l(rand(.2),rand(.2),rand(.2)),"#FF0000",w,.8,!0);K[index]-=.5;zzfx(...[1,,240,.02,.05,.08,4,3.1,,,,,.07,.2,9.4,.5,.03,.97,,.2]);
if(0>=K[index])for(zzfx(...[1.9,,729,,.04,.09,2,1.9,-7,50,-70,.08,.02,,,,,.72,.15,.14,411]),a=0;100>a;a++)bb(r(J[index]),l(rand(.2),rand(.2),rand(.2)),"#FF0000",w,.8,!0);pb=1;break}}zzfx(...[.8,,1E3,.11,.01,.21,4,.2,-.1,,,,,.4,.1,,,.59,,,19]);T-=.05;Xb=.99}};var nc=!1,Z=0,oc=null;showScene=(a,b)=>{nc||(b?(oc=a,Z=0,nc=!0):pc=a)};updateTransition=()=>{Z+=1;A.fillStyle=`rgba(0,0,0,${Math.max(50>=Z?2*Z/100:1-Z/100,0)})`;A.fillRect(0,0,R,S);50==Z&&(pc=oc,pc.l());100<Z&&(nc=!1)};menuScene=()=>({l:Gb,update:Jb});
playScene=()=>({l:dc,update:gc});gameOverScene=()=>({l:initialiseGameOverScene,update:updateGameOverScene});winScene=()=>({l:qc,update:rc});var qc=()=>{messages=[];showMessage("\ud835\udd08\ud835\udd33\ud835\udd1e\ud835\udd21\ud835\udd22\ud835\udd21",P,Q-15,30);showMessage("GG, you win.",P,Q+25,15)},rc=()=>{console.log(messages);A.clearRect(0,0,R,S);updateMessages();Fb&&showScene(playScene(),!0)};console.log("%cIntellectual property of @retro-pigeon","font-size: 20px; color: red;");
var ec=document.getElementById("glCanvas"),L=ec.getContext("webgl2"),sc=document.getElementById("hudCanvas"),A=sc.getContext("2d");const cb=(a,b=1.5)=>{a=new SpeechSynthesisUtterance(a);a.rate=b;window.speechSynthesis.speak(a)};var R,S,P,Q;function tc(){R=window.innerWidth/4;S=window.innerHeight/4;P=.5*R;Q=.5*S;sc.width=R;sc.height=S;ec.width=R;ec.height=S;void 0!==n&&void 0!==Db&&(n.o=R/S,L.uniformMatrix4fv(Db,!1,perspective(n.C,n.o,n.F,n.B)))}tc();onresize=tc;var Cb,Ab,Db,n,M,pc=menuScene();pc.l();
var F,uc=0,ac=1;
const vc=a=>{F=.01*(a-uc);uc=a;window.timeStamp=a;pc.update(F);nc&&updateTransition(F);a=navigator.getGamepads();for(let f=0;f<a.length;f++){const e=a[f];e&&(Qb=e.axes.slice(0,2),Ub=e.axes.slice(2,4),Hb=e.buttons[4].pressed,Ib=e.buttons[5].pressed)}let b=A.getImageData(0,0,R,S);A.clearRect(0,0,R,S);let c=Math.random()<F/10;b=new ImageData(new Uint8ClampedArray(b.data.map((f,e)=>3==e%4?200:0==Math.floor(e/4/R)%3?.99*b.data[e]:0==e%4?b.data[(e+(c?4*ac:8*ac))%(R*S*4)]:f)),R,S);A.putImageData(b,0,0);
requestAnimationFrame(vc)};requestAnimationFrame(vc);var lc,mc,ic,kc,Fb,jc;const wc=(a,b)=>{switch(a){case 65:lc=b;break;case 16:jc=b;break;case 87:ic=b;break;case 68:mc=b;break;case 13:Fb=b;break;case 83:kc=b}};onkeydown=a=>wc(a.keyCode,!0);onkeyup=a=>wc(a.keyCode,!1);
