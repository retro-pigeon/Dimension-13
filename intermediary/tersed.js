zzfx=(...a)=>zzfxP(zzfxG(...a));zzfxP=(...a)=>{let b=zzfxX.createBufferSource(),c=zzfxX.createBuffer(a.length,a[0].length,zzfxR);a.map((f,e)=>c.getChannelData(e).set(f));b.buffer=c;b.connect(zzfxX.destination);b.start();return b};
zzfxG=(a=1,b=.05,c=220,f=0,e=0,g=.1,k=0,p=1,q=0,u=0,B=0,N=0,W=0,Ta=0,Ga=0,qb=0,E=0,Ha=1,da=0,Ua=0)=>{let C=2*Math.PI,rb=q*=500*C/zzfxR**2,sb=(0<Ga?1:-1)*C/4;b=c*=(1+2*b*Math.random()-b)*C/zzfxR;let Ia=[],O=0,Va=0,z=0,ea=1,tb=0,ub=0,I=0,fa,X;f=99+zzfxR*f;da*=zzfxR;e*=zzfxR;g*=zzfxR;E*=zzfxR;u*=500*C/zzfxR**3;Ga*=C/zzfxR;B*=C/zzfxR;N*=zzfxR;W=zzfxR*W|0;for(X=f+da+e+g+E|0;z<X;Ia[z++]=I)++ub%(100*qb|0)||(I=k?1<k?2<k?3<k?Math.sin((O%C)**3):Math.max(Math.min(Math.tan(O),1),-1):1-(2*O/C%2+2)%2:1-4*Math.abs(Math.round(O/
C)-O/C):Math.sin(O),I=(W?1-Ua+Ua*Math.sin(2*Math.PI*z/W):1)*(0<I?1:-1)*Math.abs(I)**p*a*zzfxV*(z<f?z/f:z<f+da?1-(z-f)/da*(1-Ha):z<f+da+e?Ha:z<X-E?(X-z-E)/g*Ha:0),I=E?I/2+(E>z?0:(z<X-E?1:(X-z)/E)*Ia[z-E|0]/2):I),fa=(c+=q+=u)*Math.sin(Va*Ga-sb),O+=fa-fa*Ta*(1-1E9*(Math.sin(z)+1)%2),Va+=fa-fa*Ta*(1-1E9*(Math.sin(z)**2+1)%2),ea&&++ea>N&&(c+=B,b+=B,ea=0),!W||++tb%W||(c=b,q=rb,ea=ea||1);return Ia};zzfxV=.5;zzfxR=44100;zzfxX=new (window.AudioContext||webkitAudioContext);
var aa=[0,0,-150,-86,0,-75,-86,0,75,0,0,150,86,0,75,86,0,-75,0,50,-96,-55,50,-48,-55,50,48,0,50,96,55,50,48,55,50,-48,0,-50,-96,-55,-50,-48,-55,-50,48,0,-50,96,55,-50,48,55,-50,-48],ba=[4,9,3,2,7,1,5,10,4,3,8,2,1,6,0,0,11,5,8,10,6,15,4,3,1,14,2,4,17,5,2,15,3,12,1,0,5,12,0,12,16,14,4,10,9,2,8,7,5,11,10,3,9,8,1,7,6,0,6,11,6,7,8,8,9,10,10,11,6,15,16,4,1,13,14,4,16,17,2,14,15,12,13,1,5,17,12,14,13,12,12,17,16,16,15,14],ca=[["#80D08C",32]],ha=[-91,208,125,-91,338,-4,-91,78,-4,-206,208,-257,0,208,154,0,
367,-4,-112,288,75,-112,129,75,-124,295,-67,-124,120,-67,0,50,-4,-202,212,-397,0,318,104,-154,208,-4,0,87,-100,0,99,104,0,328,-100,-107,296,-582,-88,220,-631,-107,144,-582,0,220,-658,0,115,-611,0,325,-611,-150,345,-261,0,395,-312,0,28,-312,-188,78,-261],ia=[12,1,6,12,0,4,0,13,7,1,13,6,8,9,13,13,2,7,2,14,10,11,17,18,0,15,4,2,15,7,24,17,23,1,16,8,18,21,19,18,22,20,11,19,26,25,19,21,14,26,25,3,26,9,16,23,8,3,23,11,12,5,1,12,6,0,0,6,13,1,8,13,8,3,9,13,9,2,2,9,14,11,23,17,0,7,15,2,10,15,24,22,17,1,5,16,
18,20,21,18,17,22,11,18,19,25,26,19,14,9,26,3,11,26,16,24,23,3,8,23],ja=[["#442424",40]],ka=[-328,194,-200,-326,234,-200,-324,194,-160,-322,234,-160,-167,165,-168,-161,223,-168,-172,165,-221,-166,223,-222,-442,195,-185,-450,227,-184,-439,195,-153,-446,227,-152,-569,143,-170,-589,161,-168,-567,143,-144,-586,161,-142,-627,0,-158,-640,5,-157,-625,0,-144,-639,5,-143],la=[5,2,4,3,10,2,2,6,4,5,1,3,0,7,6,11,14,10,1,8,9,2,8,0,1,11,3,13,19,15,9,12,13,10,12,8,9,15,11,14,19,18,12,17,13,14,16,12,5,3,2,3,11,10,
2,0,6,5,7,1,0,1,7,11,15,14,1,0,8,2,10,8,1,9,11,13,17,19,9,8,12,10,14,12,9,13,15,14,15,19,12,16,17,14,18,16],ma=[["#5d5775",32]],na=[0,-26,-200,84,-26,-97,226,-26,0,84,-26,97,0,-26,200,-84,-26,97,-173,-26,0,-84,-26,-97,0,1015,0],oa=[0,8,1,1,8,2,2,8,3,3,8,4,4,8,5,5,8,6,6,8,7,7,8,0],pa=[["#247BA0",8]],qa=[-100,0,100,100,0,100,-100,0,-100,100,0,-100],ra=[1,2,0,1,3,2],sa=[["#70C1B3",2]],ta=[-70,0,70,-100,0,0,-100,23,0,-70,23,70,0,0,0,0,23,0,-35,0,35,-50,0,0,-50,23,0,-35,23,35,-82,0,82,-116,0,0,-116,13,
0,-82,13,82],ua=[5,3,9,3,4,5,3,6,0,5,1,2,8,6,9,1,8,2,2,9,3,1,12,11,0,13,3,3,12,2,13,11,12,8,2,5,9,8,5,3,0,4,3,9,6,5,4,1,8,7,6,1,7,8,2,8,9,1,2,12,0,10,13,3,13,12,13,10,11],va=[["#778899",23]],wa=[0,0,-100,-86,0,50,86,0,50,0,0,100,86,0,-50,-86,0,-50],xa=[4,5,3,1,2,0],ya=[["#FFFFFF",2]],za=[0,0,-100,-28,0,-95,-54,0,-84,-75,0,-65,-90,0,-41,-98,0,-14,-98,0,14,-90,0,41,-75,0,65,-54,0,84,-28,0,95,0,0,99,28,0,95,54,0,84,75,0,65,90,0,41,98,0,14,98,0,-14,90,0,-41,75,0,-65,54,0,-84,28,0,-95],Aa=[2,21,0,0,1,
2,2,20,21,5,18,3,3,4,5,5,17,18,18,19,3,8,15,6,6,7,8,8,14,15,15,16,6,11,13,9,9,10,11,11,12,13],Ba=[["#E87C00",3],["#E85F5A",4],["#E81F67",4],["#E700B5",3]],Ca=[-92,-2,-38,12,197,99,-83,2,-55,-6,202,99,-21,164,97,-53,131,84,-79,97,60,-95,64,29,-99,31,-4,-40,168,91,-68,135,72,-89,102,44,-99,68,11,-97,35,-23],Da=[0,13,2,7,11,12,5,9,10,0,8,13,7,6,11,5,4,9,4,3,9,8,12,13,6,10,11,4,1,3,8,7,12,6,5,10],Ea=[["#73E1E733",6],["#50BEEF22",6]],Fa=[0,1950,0,-578,2156,0,-408,2156,408,0,2156,0,-460,1806,460,-650,1806,
0,0,1806,0,-358,2446,367,-506,2480,0,0,2337,0,-151,2718,0,-107,2685,132,0,2608,0,0,2718,0,-1237,1973,0,-1236,1930,0,-1240,1950,0,-874,1930,874,-875,1973,875,-877,1950,877,-1374,0,0,-971,0,971],Ja=[3,7,9,1,9,8,1,7,2,9,11,12,9,10,8,8,11,7,10,12,13,12,11,13,11,10,13,5,4,6,4,20,5,3,2,7,1,3,9,1,8,7,9,7,11,9,12,10,8,10,11,4,21,20,16,3,1,19,6,4,19,2,3,16,5,6,15,4,5,14,15,16,17,18,19,15,18,17,18,1,2,1,14,16,16,0,3,4,17,19,19,0,6,3,0,19,19,18,2,6,0,16,16,15,5,15,17,4,15,14,18,18,14,1],Ka=[["#10E70022",18],
["#6FB2BE",20]],La=[-70,0,70,0,0,100,0,0,0,-56,-16,56,0,-16,80,0,-16,44,-31,-16,31,0,-9,44,-31,-9,31,0,-9,0],Ma=[7,9,8,4,6,3,0,4,3,5,8,6,4,5,6,0,1,4,5,7,8],Na=[["#E7000E",1],["#E7B500",6]],Oa=[0,-70,-100,86,-70,50,-86,-70,50,0,70,0],Pa=[0,3,1,0,1,2,1,3,2,2,3,0],Qa=[-70,-100,-70,-70,100,-70,-70,-70,-100,-70,70,-100,-100,100,-100,-100,-100,-100,0,-100,-100,0,100,-100,0,-100,-70,0,100,-70,0,-70,-100,0,70,-100],Ra=[0,6,8,2,4,3,3,7,11,2,6,5,1,7,4,0,5,6,2,5,4,3,4,7,2,10,6,1,9,7],Sa=[["#006699",10]],Wa=
[-98,0,89,-1,0,110,-100,0,-100,0,0,-100,-175,0,268,-78,0,292,-432,0,425,-350,0,483,-125,0,532,-25,0,535,-544,0,858,-447,0,882,-227,0,906,-130,0,932],Xa=[0,3,2,0,5,1,4,7,5,5,8,4,7,10,11,8,13,12,0,1,3,0,4,5,4,6,7,5,9,8,7,6,10,8,9,13],Ya=[26,0,123,25,0,36,26,0,11,118,0,-15,85,0,-113,-65,0,-130,-122,0,-53,-65,0,-18,-32,0,-73,36,0,-68,43,0,-42,-34,0,-19,-36,0,34,26,0,64,-39,0,59,-44,0,116],Za=[15,13,0,10,9,4,15,14,13,2,1,12,12,11,10,2,12,10,4,3,2,6,5,4,8,7,6,8,6,4,4,2,10,9,8,4],$a=[["#66ccff",12]];
const ab=()=>{let a=rand(50),b=rand(50);if(!d(a,b)&&10<Math.hypot(a,b))return ab();const c=h(aa,ba,ca,l(a,0,b),l(Math.PI/2,0,0),l(.25,.25,.25));m.push(c);const f=h(wa,xa,ya,l(a,30,b),l(Math.PI/2,0,0),l(2,2,2));m.push(f);return e=>{c.position.y=.25*Math.sin(timeStamp/1E3)+1;c.rotation.y+=e;f.rotation.y+=e*Math.random();!c.h&&10>distanceTo(c.position,n.position)&&Math.random()<e&&bb(r(c.position),l(rand(.005),rand(.025),rand(.005)),"#80D08C");if(!c.h&&3>distanceTo(c.position,n.position)){c.h=!0;t++;
zzfx(...[,,539,0,.04,.29,1,1.92,,,567,.02,.02,,,,.04]);7==t&&cb("You found all gems, return to the teleporter!");5==t&&(cb("Is it a bird? Is it a plane? It's a UFO",1.2),v.push(w()),v.push(w()),v.push(w()),v.push(w()),v.push(w()));if(1==t)for(cb("By the way, watch out for the Arachnoids",1.2),e=0;70>e;e++){var g=rand(100),k=rand(100);d(g,k)&&10<distanceTo(l(x,x,x),l(g,0,k))&&db.push(eb(l(g,0,k)))}if(3==t)for(cb("The spirits are watching...",1.2),e=0;50>e;e++)g=rand(100),k=rand(100),d(g,k)&&10<distanceTo(l(x,
x,x),l(g,0,k))&&db.push(eb(l(g,0,k),1))}}},fb=a=>{const b=h(La,Ma,Na,a,x,l(1,-1,1),1,1);m.push(b);console.log(`Landmine: ${a.x} ${a.y} ${a.z}`);return()=>{2.5>distanceTo(n.position,b.position)&&(console.log("stepped on landmine"),zzfx(...[2,,45,.01,.27,.49,3,1.6,-9,,,,,1.3,.4,.8,.2,.41,.15]),y=-.1)}};let gb=[];var d=(a,b)=>{for(const c of gb){let f=0;for(let e=0;e<c.length;e+=4){let g=c[e],k=c[e+1],p=c[e+2],q=c[e+3];b<k!==b<q&&a<g+(b-k)/(q-k)*(p-g)&&(f+=1)}if(0!==f%2)return!0}return!1};
function hb(){function a(e,g){return 0<=e&&0<=g&&50>e&&50>g}function b(e,g){c[g][e]=0;f.sort(()=>Math.random()-.5).forEach(([k,p])=>{const [q,u]=[e+k,g+p],[B,N]=[e+k/2,g+p/2];a(q,u)&&c[u][q]&&(c[N][B]=0,b(q,u))})}const c=Array.from({length:50},()=>Array(50).fill(1)),f=[[0,2],[2,0],[0,-2],[-2,0]];b(1,1);for(let e=-2;2>=e;e++)for(let g=-2;2>=g;g++)a(25+g,25+e)&&(c[25+e][25+g]=0);c[0][1]=c[49][48]=0;return c}
const ib=()=>{var a=A([]),b=hb().flat().map(c=>.2>Math.random()?0:c);for(let c=0;2500>c;c++){const f=c%50*4-100+3,e=4*Math.floor(c/50)-100+3;if(b[c])a.g.push(h(na,oa,pa,l(f,0,e),l(.2-.4*Math.random(),Math.random()*Math.PI*2,0),l(1,1,1)));else{let g=.2*b[c-50],k=-.2*b[c+50],p=.2*b[c-1],q=-.2*b[c+1];gb.push([f-2+p,e-2+g,f-2+p,e+2+k,f-2+p,e+2+k,f+2+q,e+2+k,f+2+q,e+2+k,f+2+q,e-2+g,f+2+q,e-2+g,f-2+p,e-2+g])}}m.push(a)};messages=[];
showMessage=(a,b,c,f=50,e=1E6,g=0)=>messages.push({text:a,x:b,y:c,size:f,duration:e,delay:g,counter:0,S:Math.max(random(3),1)});
updateMessages=()=>{messages.forEach((a,b)=>{0<a.delay--||(a.counter+=1,D.font=`${a.size}px ${"serif"}`,D.textAlign="center",D.textBaseline="middle",100>a.duration&&(a.y-=a.S),20>=a.counter&&(D.fillStyle=`rgba(255,255,255 ,${a.counter/20})`),20<a.counter&&a.counter<=a.duration-60&&(D.fillStyle="white"),a.counter>a.duration-60&&(D.fillStyle=`rgba(255,255,255,${-(a.counter-a.duration)/60})`),D.fillText(a.text,a.x,a.y),a.counter>a.duration&&messages.splice(b,1))})};
let jb=[],lb=()=>{let a=l(Math.cos(timeStamp/1E3)/10+.025-Math.random()/20,0,Math.sin(timeStamp/1E3)/10+.025-Math.random()/20),b=[];jb.forEach((c,f)=>{c.i.position=F(c.i.position,c.s);c.i.position=F(c.i.position,multiplyBy(a,G));c.i.rotation=F(c.i.rotation,c.N);c.counter-=G/20;c.i.opacity=Math.max(c.counter/c.K,0);0>=c.counter?(c.i.h=!0,b.push(f)):c.I&&(c.s.y-=.02*G)});b.reverse().forEach(c=>{kb.g.splice(c,1);jb.splice(c,1)})};
const bb=(a,b,c="#FFFFFF",f=l(.005-.01*Math.random(),.05-.01*Math.random(),.005-.01*Math.random()),e=1,g=!1,k=.2)=>{a=h(Oa,Pa,[[c,4]],a,x,l(k,k,k));kb.g.push(a);jb.push({i:a,s:b,counter:e,N:f,K:e,I:g})},mb=a=>{let b=A([h(Ya,Za,$a,x,l(Math.PI/2,0,0),l(.2,.2,.2)),h(Qa,Ra,Sa,x,x,l(.4,.4,.4),1,1)]);b.position=a;m.push(b);return c=>{b.g[0].rotation.y=angleBetween(b.position,n.position);b.g[1].rotation.x+=c/5;b.g[1].rotation.z+=c/5;b.position.y=1.5+Math.sin(timeStamp/500)/2;!b.h&&1>distanceTo(n.position,
b.position)&&(H=.999,J=1,b.h=!0,b.g[0].h=!0,b.g[1].h=!0);!b.h&&10>distanceTo(n.position,b.position)&&Math.random()<c&&bb(r(b.position),l(rand(.05),.1,rand(.05)),"#66ccff",x,x,1)}};var K=[],L=[],nb=[],ob=0;
const eb=(a,b=!1)=>{let c=db.length,f=0,e=3;K.push(a);L.push(1+Math.random()/2);nb.push(1);let g=A([h(ha,ia,ja,l(0,0,.8),x,l(.25,.25,.25),1),h(ka,la,ma,l(0,0,0),x,l(.25,.25,.25),1),h(ka,la,ma,l(0,0,.4),x,l(.25,.25,.25),1),h(ka,la,ma,l(0,0,.8),x,l(.25,.25,.25),1),h(ka,la,ma,l(0,0,1.2),x,l(.25,.25,.25),1)]);g.scale=l(L[c],L[c],L[c]);g.position=a;b||m.push(g);return k=>{if(0>=L[c])g.h=!0,nb[c]=0;else if(e-=k,f+=k,g.g[1].rotation=l(0,.05*Math.cos(f),.15*Math.sin(f)),g.g[2].rotation=l(0,.05*Math.sin(f),
.15*Math.cos(f)),g.g[3].rotation=l(0,.05*Math.cos(f),.15*Math.sin(f)),g.g[4].rotation=l(0,.05*Math.sin(f),.15*Math.cos(f)),g.rotation.y=Math.atan2(n.position.x-g.position.x,n.position.z-g.position.z),!(4.358>=distanceTo(l(x,x,x),n.position))){if(3<distanceTo(g.position,n.position)&&5<distanceTo(l(x,x,x),g.position)&&10>=distanceTo(g.position,n.position)){var p=r(g.position);p.x+=Math.sin(g.rotation.y)*k;p.z+=Math.cos(g.rotation.y)*k;(b||d(p.x,p.z))&&5<distanceTo(l(x,x,x),g.position)&&(g.position=
p)}.1<ob&&(p=r(g.position),p.x-=Math.sin(g.rotation.y)*k*ob*5,p.z-=Math.cos(g.rotation.y)*k*ob*5,zzfx(...[,,73,,.02,.07,4,3.6,,,,,.03,.5,14,.8,.01,.62]),d(p.x,p.z)&&5<distanceTo(l(x,x,x),g.position)&&(g.position=p),ob-=k/10);4>distanceTo(g.position,n.position)&&0>=e&&(y-=.05,e=3,zzfx(...[,,100,,.04,,4,5,,,,,,1.4,,.1,,.89,,,-2247]),pb());if(b&&10>=distanceTo(g.position,n.position))for(p=0;1>p;p++)bb(F(g.position,l(0,1.8,0)),l(rand(.1),rand(.1),rand(.1)),"#FFFFFF",x,1,!0,.3);10>=distanceTo(g.position,
n.position)&&Math.random()<k/20&&zzfx(...[,,770,.3,,.22,2,4.6,-87,,48,.52,.06,,,,,.54,.14,.13,-554]);K[c]=g.position}}},w=()=>{const a=h(Fa,Ja,Ka,void 0,void 0,l(.56,.56,.56),1,1);a.position=l(100-200*Math.random(),void 0,100-200*Math.random());m.push(a);let b=l(100-200*Math.random(),void 0,100-200*Math.random());return c=>{var f=substract(b,a.position);1>length(f)?b=l(100-200*Math.random(),void 0,100-200*Math.random()):(f=normalize(f),f=multiplyBy(f,1*c),a.position=F(a.position,f));6>distanceTo(n.position,
a.position)&&(y-=1*c)}};function pb(){const a=navigator.getGamepads()[0];a?a.R?a.R.U("dual-rumble",{V:0,duration:1,Y:0,W:.1}).catch(b=>console.log("Vibration error:",b)):console.log("Vibration actuator not available on this gamepad."):console.log("Gamepad with index 0 not found.")}
const vb=(a,b,c,f=0,e=0)=>{var g=b.length,k=[],p=[];for(var q of b)k.push(a[3*q],a[3*q+1],a[3*q+2]);for(q=0;q<c.length;q+=4)p.push(c[q],c[q+1],c[q+2],c[q+3],c[q],c[q+1],c[q+2],c[q+3],c[q],c[q+1],c[q+2],c[q+3]);f&&(k=[...k,...k.map((u,B)=>B%3?u:-u)],p=[...p,...p],g*=2);e&&(k=[...k,...k.map((u,B)=>2==B%3?-u:u)],k=[...k,...k.map((u,B,N)=>1==B%3?u:2==B%3?N[B-2]:N[B+2])],p=[...p,...p,...p,...p],g*=4);f=CreateAndBindBufferData(k);p=CreateAndBindBufferData(p);k=CreateAndBindBufferData(getNormals(k));M.bindBuffer(M.ARRAY_BUFFER,
null);return{X:a,indices:b,T:c,J:g,P:f,G:p,M:k}};getNormals=a=>{let b=[];for(let c=0;c<a.length;c+=9){let f=cross(normalize(l(a[c+3]-a[c],a[c+3+1]-a[c+1],a[c+3+2]-a[c+2])),normalize(l(a[c+6]-a[c],a[c+6+1]-a[c+1],a[c+6+2]-a[c+2])));b.push(f.x,f.y,f.z,f.x,f.y,f.z,f.x,f.y,f.z)}return b};CreateAndBindBufferData=a=>{const b=M.createBuffer();M.bindBuffer(M.ARRAY_BUFFER,b);M.bufferData(M.ARRAY_BUFFER,new Float32Array(a),M.STATIC_DRAW);return b};
const A=a=>({L:!0,position:l(0,0,0),rotation:l(0,0,0),scale:l(1,1,1),g:a}),l=(a=0,b=0,c=0)=>({x:a,y:b,z:c}),r=a=>l(a.x,a.y,a.z),F=(a,b)=>l(a.x+b.x,a.y+b.y,a.z+b.z);substract=(a,b)=>l(a.x-b.x,a.y-b.y,a.z-b.z);multiplyBy=(a,b)=>l(a.x*b,a.y*b,a.z*b);divide=(a,b)=>l(a.x/b,a.y/b,a.z/b);length=a=>Math.hypot(a.x,a.y,a.z);cross=(a,b)=>l(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x);dot=(a,b)=>a.x*b.x+a.y*b.y+a.z*b.z;normalize=a=>divide(a,length(a));
rotX=(a,b)=>l(a.x,a.y*Math.cos(b)-a.z*Math.sin(b),a.y*Math.sin(b)+a.z*Math.cos(b));rotY=(a,b)=>l(a.x*Math.cos(b)-a.z*Math.sin(b),a.y,a.x*Math.sin(b)+a.z*Math.cos(b));rotZ=(a,b)=>l(a.x*Math.cos(b)-a.y*Math.sin(b),a.x*Math.sin(b)+a.y*Math.cos(b),a.z);distanceTo=(a,b)=>length(substract(a,b));translate=a=>new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,a.x,a.y,a.z,1]);scale=a=>new Float32Array([a.x,0,0,0,0,a.y,0,0,0,0,a.z,0,0,0,0,1]);
rotateX=a=>{const b=Math.sin(a);a=Math.cos(a);return new Float32Array([1,0,0,0,0,a,b,0,0,-b,a,0,0,0,0,1])};rotateY=a=>{const b=Math.sin(a);a=Math.cos(a);return new Float32Array([a,0,-b,0,0,1,0,0,b,0,a,0,0,0,0,1])};rotateZ=a=>{const b=Math.sin(a);a=Math.cos(a);return new Float32Array([a,b,0,0,-b,a,0,0,0,0,1,0,0,0,0,1])};perspective=(a,b,c,f)=>{a=1/Math.tan(a/2);const e=1/(c-f);return new Float32Array([a/b,0,0,0,0,a,0,0,0,0,(f+c)*e,-1,0,0,2*f*c*e,0])};
lookAt=(a,b,c)=>{b=normalize(substract(a,b));c=normalize(cross(c,b));const f=cross(b,c);return new Float32Array([c.x,f.x,b.x,0,c.y,f.y,b.y,0,c.z,f.z,b.z,0,-dot(c,a),-dot(f,a),-dot(b,a),1])};multiply=(a,b)=>{const c=new Float32Array(16);for(let f=0;4>f;f++)for(let e=0;4>e;e++){let g=0;for(let k=0;4>k;k++)g+=a[4*f+k]*b[4*k+e];c[4*f+e]=g}return c};transform=(a,b,c)=>multiply(multiply(scale(c),multiply(multiply(rotateX(b.x),rotateY(b.y)),rotateZ(b.z))),translate(a));lerp=(a,b,c)=>a+(b-a)*c;
random=(a=1)=>Math.random()*a;randomBetween=a=>a-Math.random()*a*2;lerpColors=(a,b,c)=>Color(a.r+(b.r-a.r)*c,a.D+(b.D-a.D)*c,a.b+(b.b-a.b)*c);easeInOutCubic=a=>.5>a?4*a*a*a:1-Math.pow(-2*a+2,3)/2;angleBetween=(a,b)=>Math.atan2(a.x-b.x,a.z-b.z);abs=Math.abs;rand=a=>a-2*a*Math.random();
const h=(a,b,c,f=l(),e=l(),g=l(1,1,1),k=0,p=0)=>{let q=[];for(let u of c)for(c=0;c<u[1];c++)q.push(...wb(u[0]));return{m:vb(a.map(u=>u/100),b,q,k,p),position:f,rotation:e,scale:g}},wb=a=>[parseInt(a.slice(1,3),16)/255,parseInt(a.slice(3,5),16)/255,parseInt(a.slice(5,7),16)/255,parseInt(a.slice(7,9),16)/255||1];var xb=15;
const Ab=(a,b,c=1,f=null)=>{c&&(M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),M.uniform1f(yb,xb),M.viewport(0,0,M.canvas.width,M.canvas.height),M.uniformMatrix4fv(zb,!1,lookAt(b.position,b.target,b.O)));for(const e of a)e.h||(e.L?Ab(e.g,b,0,transform(e.position,e.rotation,e.scale)):(M.uniform1f(uOpacityLocation,e.opacity||1),bindBufferAttribute(e.m.P,P.A),bindBufferAttribute(e.m.G,P.v,4),bindBufferAttribute(e.m.M,P.u),f?M.uniformMatrix4fv(Bb,!1,multiply(transform(e.position,e.rotation,e.scale),f)):
M.uniformMatrix4fv(Bb,!1,transform(e.position,e.rotation,e.scale)),M.drawArrays(M.TRIANGLES,0,e.m.J),M.bindBuffer(M.ARRAY_BUFFER,null)))};bindBufferAttribute=(a,b,c=3)=>{M.bindBuffer(M.ARRAY_BUFFER,a);M.vertexAttribPointer(b,c,M.FLOAT,!1,0,0);M.enableVertexAttribArray(b)};var yb;
const Db=()=>{M.clearColor(.2,.094,.196,1);M.enable(M.DEPTH_TEST);M.clearDepth(1);M.depthFunc(M.LEQUAL);M.enable(M.BLEND);M.blendFunc(M.SRC_ALPHA,M.ONE_MINUS_SRC_ALPHA);M.disable(M.CULL_FACE);P=M.createProgram();compileShader("#version 300 es\nprecision mediump float;uniform mat4 uMeshMatrix,uCameraMatrix,uProjectionMatrix;in vec3 B,D;in vec4 C;out vec4 A,E,Z;out vec3 F;void main(){gl_Position=uProjectionMatrix*uCameraMatrix*uMeshMatrix*vec4(B,1);E=C;A=gl_Position;Z=uMeshMatrix*vec4(B,1.0);}",M.VERTEX_SHADER,
P);compileShader("#version 300 es\nprecision mediump float;in vec4 A;in vec3 F;in vec4 Z,E;uniform float G,O;out vec4 fragColor;void main(){float P=max(min(1.-A.z/G,1.),.05)+.05-fract(sin(dot(A.xy.xy,vec2(12.9898,78.233)))*43758.5453123)*.1;P*=P;if(Z.y>10.1)P=1.;fragColor=mix(vec4(.2,.094,.196,1.0),E,P);fragColor.w*=O;}\n",M.FRAGMENT_SHADER,P);M.linkProgram(P);M.useProgram(P);Bb=M.getUniformLocation(P,"uMeshMatrix");zb=M.getUniformLocation(P,"uCameraMatrix");Cb=M.getUniformLocation(P,"uProjectionMatrix");
const a=(new Float32Array(60)).fill(0).map((b,c)=>1==c%3?0:40-80*Math.random());M.uniform3fv(M.getUniformLocation(P,"uLightPosition"),a);yb=M.getUniformLocation(P,"G");M.uniform1f(yb,15);uOpacityLocation=M.getUniformLocation(P,"O");M.uniform1f(uOpacityLocation,1);M.uniformMatrix4fv(Cb,!1,perspective(n.C,n.o,n.F,n.B));P.A=M.getAttribLocation(P,"B");M.enableVertexAttribArray(P.A);P.v=M.getAttribLocation(P,"C");M.enableVertexAttribArray(P.v);P.u=M.getAttribLocation(P,"D");M.enableVertexAttribArray(P.u)};
compileShader=(a,b,c)=>{b=M.createShader(b);M.shaderSource(b,a);M.compileShader(b);M.getShaderParameter(b,M.COMPILE_STATUS)?M.attachShader(c,b):console.error("Shader compilation error:",M.getShaderInfoLog(b))};initialiseGameOverScene=()=>{messages=[];showMessage("\ud835\udd72\ud835\udd8d\ud835\udd94\ud835\udd98\ud835\udd99 \ud835\udd86\ud835\udd8c\ud835\udd86\ud835\udd8e\ud835\udd93",Q,R-15,30);showMessage("Press enter to reincarnate!",Q,R+25,15)};
updateGameOverScene=()=>{console.log(messages);D.clearRect(0,0,S,T);updateMessages();Eb&&window.location.reload()};
const Fb=()=>{messages=[];showMessage("\ud835\udd6f\ud835\udd8e\ud835\udd92\ud835\udd8a\ud835\udd93\ud835\udd98\ud835\udd8e\ud835\udd94\ud835\udd93",Q,.5*R,.4*R,1E7,30);showMessage("\ud835\udd7f\ud835\udd8d\ud835\udd8e\ud835\udd97\ud835\udd99\ud835\udd8a\ud835\udd8a\ud835\udd93",Q,.85*R,.4*R,1E7,35);showMessage("Escape the thirteenth dimension",Q,1.2*R,.2*R,1E7,60)},Ib=()=>{D.fillStyle="black";D.fillRect(0,0,S,T);updateMessages();(Eb||Gb||Hb)&&showScene(playScene(),!0)};document.onclick=()=>{document.documentElement.requestPointerLock()};
var Jb=Math.random()*Math.PI*2,Kb,U=1,Lb=[],t=0,y=1,Mb=.2,Nb=[],Ob=[],Pb,m,kb,Qb,Rb,Sb=0,Tb,db=[],Ub,Vb=A([]),Wb=.99,V=0,Xb=0,v=[],x,J=1,H=.999,Gb,Hb,Yb=-1,Zb=0,Y="\ud83d\udca9 \u2764\ufe0f \ud83d\udc41\ufe0f \ud83d\udee1\ufe0f \ud83e\udebd \u23f3 \u26a1 \u2694\ufe0f".split(" ");
const cc=()=>{messages=[];Ub=A([]);for(var a=0;10>a;a++)Ub.g.push(h(Ca,Da,Ea,l(0,0,0),l(0,a/10*Math.PI*2,0),l(4.5,4.5,4.5)));m=[h(qa,ra,sa,x,x,l(1E3,1E3,1E3)),h(ta,ua,va,l(0,.1,0),l(0,Math.PI/4,0),l(4.5,1,4.5),1,1),A([h(za,Aa,Ba,l(0,90,0),x,l(30,30,30))])];n={position:l(0,1.69,0),direction:l(0,0,1),H:1.4,j:0,pitch:0,target:l(0,0,0),C:Math.PI/2,o:S/T,F:.1,B:200,O:l(0,1,0)};setInterval(()=>{if(4.358<distanceTo(l(x,x,x),n.position)){if(12<=V){Sb=.5;$b=2;v.push(w());for(let f=0;f<V*V/10;f++){let e=100-
200*Math.random(),g=100-200*Math.random();d(e,g)&&1<distanceTo(l(x,x,x),l(e,0,g))&&10<distanceTo(n.position,l(e,0,g))&&db.push(eb(l(e,0,g),.3>Math.random()))}zzfx(...[2.1,0,1E6,,.5,0,3,2.6,,,,,,,,.5])}else $b=1;zzfx(...[2,.8,100,,,,,1.5,,.3,-99,.1,1.63,,,.11,.22]);Xb=1;V++;13==V&&cb("Run back")}},950);setInterval(()=>{zzfx(...[.4,.1,10,,.07,.26,,5,,,-100,.01,,,,,.25,.73,,,-1473]);Mb=.8;y+=.05},1200);Db();document.addEventListener("click",ac);document.addEventListener("mousemove",bc);ib();for(a=0;100>
a;a++){var b=100-200*Math.random(),c=100-200*Math.random();d(b,c)&&10<distanceTo(l(x,x,x),l(b,0,c))&&Ob.push(fb(l(b,0,c)))}for(a=0;7>a;a++)Lb.push(ab());for(a=0;1E3>a;a++)Vb.g.push(h(wa,xa,ya,l(rand(150),30,rand(150)),x,l(.5,.5,.5)));for(a=0;200>a;a++)b=Math.random()/10+.1,m.push(h(Wa,Xa,[["#382847",12]],l(rand(100),0,rand(100)),l(-Math.PI/2,rand(Math.PI),0),l(b,b,b),1));m.push(Vb);m.push(Ub);kb=A([]);m.push(kb);Nb=[mb(l(0,2,0))];for(a=0;100>a;a++)b=100-200*Math.random(),c=100-200*Math.random(),d(b,
c)&&10<distanceTo(l(x,x,x),l(b,0,c))&&Nb.push(mb(l(b,0,c)))},fc=a=>{xb=2*Math.sin(timeStamp/200)+10+.4*Math.random()-.8;Zb-=a/10;if(0<Zb)switch(Yb){case 0:Zb=0;break;case 1:y+=.5;break;case 2:xb=100;break;case 5:V=13;break;case 6:U=1}D.globalAlpha=1;J-=a/20;J=Math.max(J,0);Qb++;Mb*=Mb;Sb-=a/10;Math.random()<a/1E3&&zzfx(...[1.6,,182,,.05,.25,1,3.5,,7,,,.09,.4,,.1,.04,.81,.31,.03,-1260]);m[2].rotation.x+=a/40;Ub.rotation.y+=a/40;db.forEach(c=>c(a));Lb.forEach(c=>c(a));v.forEach(c=>c(a));Ob.forEach(c=>
c(a));Nb.forEach(c=>c(a));D.drawImage(dc,0,0);D.fillStyle="white";D.font=`${15*(1+Xb)}px monospace`;Xb-=a;Xb*=Xb;D.fillText(V,10,20);D.fillRect(Q-.5,R-3.5,.5,7);D.fillRect(Q-3.5,R-.5,7,.5);D.fillStyle="#E37E90";D.fillRect(S/4-10,10,Q*Math.max(Math.min(1,y),0),5);D.font=`${15*(1+Mb)}px sans-serif`;D.fillText("\u2764\ufe0f",S/4-10,15);D.fillStyle="#E8C165";D.fillRect(S/4-10,25,Q*Math.max(Math.min(1,U),0),5);D.font="15px sans-serif";D.fillText("\u26a1",S/4-10,30);D.strokeStyle="#BFDDE722";D.lineWidth=
(Q>>1)*Wb;D.beginPath();D.arc(Q,1.5*T,Q,0,Wb*Math.PI+Math.PI);D.stroke();D.fillStyle="#FF000022";0<Sb&&D.fillRect(0,0,S,T);0<Zb&&D.fillText(Y[Yb],10,T-10);D.fillStyle="#80D08C";D.fillText("\u2b21\u2b21\u2b21\u2b21\u2b21\u2b21\u2b21".replace(/\u2b21/g,(c,f)=>f<t?"\u2b22":c),S-40,10);var b=-1;Jb+=J*J*a*Math.random()*5;for(let [c,f]of Y.entries())D.strokeStyle=c&1?"#886CDB":"#9880E0",(Jb+((c+Y.length+1)*Math.PI*2/Y.length+Math.PI/2))%(2*Math.PI)<2*Math.PI/Y.length&&.01<=J&&(b=c),D.strokeStyle,D.lineWidth=
.7*R,D.beginPath(),D.arc(Q,R+15,R/2*.7*H,2*Math.PI/Y.length*c+Jb,2*Math.PI/Y.length*(c+1)+Jb),D.stroke(),.01<H&&D.fillText(f,Q+.6*R*H*Math.cos(2*Math.PI/Y.length*(.5+c)+Jb),R+.6*R*H*Math.sin(2*Math.PI/Y.length*(.5+c)+Jb)+15);.01>J&&-1!=b&&(Yb=b,Zb=1,b=-1);.01>J&&(H*=H);Wb*=Math.pow(Wb,60*a);1<y&&(y=1);4.358>distanceTo(l(x,x,x),n.position)&&(V=0);6<t&&showScene(winScene(),!0);Vb.rotation.y+=a/100;updateMessages();0>y&&showScene(gameOverScene(),!0);3==Yb&&0<Zb&&(y=1);lb();Rb=Gb;ec(a);Ab(m,n)};
var gc=0;
const ec=a=>{gc-=a/10;let b=l(0,0,0);hc?(0>=gc&&(zzfx(...[2.3,,201,,,.002,,4.5,,2,,,,,,,,.98,,,178]),gc=ic?.3:.5),b=l(0,0,1+(ic&&0<U))):jc?b=l(0,0,-2/3):kc?b=l(2/3,0,0):lc?b=l(-2/3,0,0):Hb||Pb&&!(.1>Math.abs(Pb[1]))||(U=Math.min(U+a/50,1));Pb&&(n.j+=1*Pb[0]*a,b.z=-Pb[1]*(1+Hb));Tb&&(n.j+=Tb[0]/2*a,n.pitch-=Tb[1]/2*a);0==Rb&&1==Gb&&ac();if(Hb||ic)U-=a/100;Kb=F(n.position,multiplyBy(rotY(b,n.j),n.H*a));d(Kb.x,Kb.z)&&(n.position=Kb);n.direction=F(rotY(l(0,0,1),n.j),l(0,n.pitch,0));n.target=F(n.position,
n.direction)},bc=a=>{n.j+=a.movementX/500;n.pitch-=a.movementY/500},ac=()=>{if(!(0>U)){document.documentElement.requestPointerLock();var a=n;let c=substract(a.position,a.target);for(index in K){var b=normalize(substract(a.position,K[index]));b=substract(c,b);b=abs(b.x)+abs(b.y)+abs(b.z);if(5>distanceTo(a.position,K[index])&&3>b&&nb[index]){for(a=0;20>a;a++)bb(r(K[index]),l(rand(.2),rand(.2),rand(.2)),"#FF0000",x,.8,!0);L[index]-=.5;zzfx(...[1,,240,.02,.05,.08,4,3.1,,,,,.07,.2,9.4,.5,.03,.97,,.2]);
if(0>=L[index])for(zzfx(...[1.9,,729,,.04,.09,2,1.9,-7,50,-70,.08,.02,,,,,.72,.15,.14,411]),a=0;100>a;a++)bb(r(K[index]),l(rand(.2),rand(.2),rand(.2)),"#FF0000",x,.8,!0);ob=1;break}}zzfx(...[.8,,1E3,.11,.01,.21,4,.2,-.1,,,,,.4,.1,,,.59,,,19]);U-=.05;Wb=.99}};var mc=!1,Z=0,nc=null;showScene=(a,b)=>{mc||(b?(nc=a,Z=0,mc=!0):oc=a)};updateTransition=()=>{Z+=1;D.fillStyle=`rgba(0,0,0,${Math.max(50>=Z?2*Z/100:1-Z/100,0)})`;D.fillRect(0,0,S,T);50==Z&&(oc=nc,oc.l());100<Z&&(mc=!1)};menuScene=()=>({l:Fb,update:Ib});
playScene=()=>({l:cc,update:fc});gameOverScene=()=>({l:initialiseGameOverScene,update:updateGameOverScene});winScene=()=>({l:pc,update:qc});var pc=()=>{messages=[];showMessage("\ud835\udd08\ud835\udd33\ud835\udd1e\ud835\udd21\ud835\udd22\ud835\udd21",Q,R-15,30);showMessage("GG, you win.",Q,R+25,15)},qc=()=>{console.log(messages);D.clearRect(0,0,S,T);updateMessages();Eb&&showScene(playScene(),!0)};console.log("%cIntellectual property of @retro-pigeon","font-size: 20px; color: red;");
var dc=document.getElementById("glCanvas"),M=dc.getContext("webgl2"),rc=document.getElementById("hudCanvas"),D=rc.getContext("2d");const cb=(a,b=1.5)=>{a=new SpeechSynthesisUtterance(a);a.rate=b;window.speechSynthesis.speak(a)};var S,T,Q,R;function sc(){S=window.innerWidth/4;T=window.innerHeight/4;Q=.5*S;R=.5*T;rc.width=S;rc.height=T;dc.width=S;dc.height=T;void 0!==n&&void 0!==Cb&&(n.o=S/T,M.uniformMatrix4fv(Cb,!1,perspective(n.C,n.o,n.F,n.B)))}sc();onresize=sc;var Bb,zb,Cb,n,P,oc=menuScene();oc.l();
var G,tc=0,$b=1;
const uc=a=>{G=.01*(a-tc);tc=a;window.timeStamp=a;oc.update(G);mc&&updateTransition(G);a=navigator.getGamepads();for(let f=0;f<a.length;f++){const e=a[f];e&&(Pb=e.axes.slice(0,2),Tb=e.axes.slice(2,4),Gb=e.buttons[4].pressed,Hb=e.buttons[5].pressed)}let b=D.getImageData(0,0,S,T);D.clearRect(0,0,S,T);let c=Math.random()<G/10;b=new ImageData(new Uint8ClampedArray(b.data.map((f,e)=>3==e%4?200:0==Math.floor(e/4/S)%3?.99*b.data[e]:0==e%4?b.data[(e+(c?4*$b:8*$b))%(S*T*4)]:f)),S,T);D.putImageData(b,0,0);
requestAnimationFrame(uc)};requestAnimationFrame(uc);var kc,lc,hc,jc,Eb,ic;const vc=(a,b)=>{switch(a){case 65:kc=b;break;case 16:ic=b;break;case 87:hc=b;break;case 68:lc=b;break;case 13:Eb=b;break;case 83:jc=b}};onkeydown=a=>vc(a.keyCode,!0);onkeyup=a=>vc(a.keyCode,!1);
