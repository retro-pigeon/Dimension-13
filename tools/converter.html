<!--- Takes a obj and converts it to a more readable format. Make sure model is triangulated --->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        function objtodad(obj) {
            let lines = obj.split('\n');
            let output = '';

            for (let line of lines) {
                const split = line.split(' ')
                let instruction = split[0];
                split.shift()
                let data = split.join(' ');

                if (instruction == 'v') {
                    output += data.split(' ').join(',');
                }

                if (instruction == 'f') {
                    if (output.indexOf(':') == -1)
                        output += ':';
                    output += data.split(' ').map(input => input.split('/')[0]).join(',') + ';';
                }
            }
            return output;
        }

        function bintogeometry(obj) {
            const verts = stringToCharCodeArray(obj.split('ÿ')[0]); //charcode 255
            const indices = stringToCharCodeArray(obj.split('ÿ')[1]).map(str => str * 254); //multiply by 254 for indices

            return { verts, indices };
        }

        const convert = value => (value + 127.5) / 255;

        function objtobin(obj) {
            let lines = obj.split('\n');
            let output = '';
            let colors = [];

            for (let line of lines) {
                const split = line.split(' ')
                let instruction = split[0];
                let currentColor = '#ff0000';
                split.shift()
                let data = split.join(' ');

                if (instruction == 'v') {
                    output += data.split(' ').map(s => String.fromCharCode(+s * 256 + 128).replace('\\', '\\\\').replace('\0', '\\0')).join``;
                }

                if (instruction == 'f') {
                    if (output.indexOf('ÿ') == -1)
                        output += 'ÿ';
                    output += data.split(' ').map(input => String.fromCharCode(+(input.split('/')[0])).replace('\\', '\\\\').replace('\0', '\\0')).join(``);
                    output += String.fromCharCode(colors.length - 1);
                }

                if (instruction == 'usemtl') {
                    color = data;
                    colors.push(color);
                }
            }
            console.log(colors);
            return output + 'ÿ' + colors.join``;
        }

        function hexToRgbArray(hex) {
            // Remove the "#" symbol if it exists
            hex = hex.replace(/^#/, '');

            // Parse the hex values for red, green, and blue
            const r = parseInt(hex.slice(0, 2), 16) / 255;
            const g = parseInt(hex.slice(2, 4), 16) / 255;
            const b = parseInt(hex.slice(4, 6), 16) / 255;

            // Return the RGB color as an array with values in the [0, 1] range
            return [r, g, b];
        }

        function parseOBJ(objString) {
            const parsedObjects = {};
            let currentObject = null;
            let currentColor = '#deadbeef';
            let currentColorCount = 0;
            let indexOffset = 0;

            const lines = objString.split('\n');

            for (let line of lines) {
                const parts = line.trim().split(/\s+/);

                if (parts[0] === 'o' && parts[1]) {
                    // Start of a new object
                    if (currentObject !== null) {
                        // If there's data in the current object, push it to the array
                        indexOffset += currentObject.data.vertices.length / 3;
                        parsedObjects[currentObject.name] = currentObject.data;
                    }
                    // Create a new object with an empty data object
                    currentObject = { name: parts[1], data: { vertices: [], normals: [], indices: [], colors: [] } };
                } else if (parts[0] === 'v') {
                    // Vertex
                    currentObject.data.vertices.push(Math.trunc(parseFloat(parts[1]) * 100), Math.trunc(parseFloat(parts[2]) * 100), Math.trunc(parseFloat(parts[3]) * 100));
                }
                else if (parts[0] === 'f') {
                    // Face
                    for (let i = 1; i < 4; i++) {
                        const faceData = parts[i].split('/');
                        currentObject.data.indices.push(parseInt(faceData[0]) - 1 - indexOffset); // OBJ indices start from 1!

                    }
                    currentColorCount++;
                } else if (parts[0] === 'usemtl') {
                    if (currentColorCount != 0)
                        currentObject.data.colors.push([currentColor, currentColorCount]);
                    currentColor = parts[1];
                    currentColorCount = 0;
                } 
            }

            if (currentColorCount != 0)
                    currentObject.data.colors.push([currentColor, currentColorCount]);

            if (currentObject !== null) {
                indexOffset += currentObject.data.vertices.length / 3;
                parsedObjects[currentObject.name] = currentObject.data;
            }

            return parsedObjects;
        }


        // Example usage:
        // const objString = '...'; // Your OBJ file content as a string
        // const { vertices, normals, indices } = parseOBJ(objString);


        const stringToCharCodeArray = s => [...s].map(c => c.charCodeAt() / 254);//note that it returns values between 0 and 1
        const charCodeArrayToString = a => a.map(i => String.fromCharCode(i * 254 | 0)).join``;

        console.log(stringToCharCodeArray(charCodeArrayToString([.3, .5, .8, .9])))

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.click();

            URL.revokeObjectURL(url);
        }


        // Example usage:
        // const plyString = '...'; // Your PLY file content as a string
        // const { vertices, normals, colors, indices, vertexFormat } = parsePLY(plyString);


        console.log(JSON.stringify(parseOBJ(`# Blender 4.2.0
# www.blender.org
mtllib dungeon2.mtl
o Cube
v -4.039141 2.000582 -4.000000
v -4.039141 0.000582 -4.000000
v -1.105808 2.000582 -4.000000
v -1.105808 0.000582 -4.000000
v -1.107949 1.021167 -4.001128
v 0.001072 1.990573 -4.000000
v -0.752394 1.538095 -4.001128
v -0.396838 1.685439 -4.001128
v -0.001069 1.702233 -4.001128
v -1.105812 2.007776 -6.999991
v -1.105812 0.007775 -6.999991
v -1.107953 1.028360 -7.001120
v 0.001069 1.997766 -6.999991
v -0.752397 1.545287 -7.001120
v -0.396842 1.692633 -7.001120
v -0.001072 1.709427 -7.001120
v -2.705812 2.007776 -6.999991
v -2.705812 0.007775 -6.999991
v -2.705812 2.007775 -12.000000
v -2.705812 0.007775 -12.000000
v 0.000000 0.000000 0.000000
v -12.000001 -0.000001 -11.999999
v -0.000001 -0.000001 -12.000001
v 0.000000 2.000000 -0.000000
v -12.000001 1.999999 -11.999999
v -0.000001 1.999999 -12.000001
vn -0.0000 -0.0000 -1.0000
vn -0.0001 0.0033 -1.0000
vn 0.8239 -0.5667 -0.0014
vn 0.3828 -0.9238 -0.0022
vn 0.0424 -0.9991 -0.0024
vn 1.0000 0.0021 -0.0000
vn -0.0000 -0.0037 1.0000
vn -1.0000 -0.0000 -0.0000
vn -0.0000 -0.0000 1.0000
vn -0.0000 1.0000 -0.0000
vn -0.0017 0.0012 -1.0000
vn -0.0000 0.0039 -1.0000
vn -0.0008 0.0019 -1.0000
vn 0.0017 -0.0012 1.0000
vn 0.0002 -0.0039 1.0000
vn 0.0008 -0.0019 1.0000
vt 0.625000 0.500000
vt 0.375000 0.583333
vt 0.375000 0.500000
vt 0.000000 0.000000
vt 1.000000 1.000000
vt 0.000000 1.000000
vt 0.625000 0.583333
s 0
usemtl Material.001
f 1/1/1 4/2/1 2/3/1
f 10/4/2 16/4/2 15/4/2
f 7/4/3 12/4/3 14/4/3
f 8/4/4 14/4/4 15/4/4
f 9/4/5 15/4/5 16/4/5
f 5/4/6 11/4/6 12/4/6
f 3/4/7 8/4/7 6/4/7
f 17/4/8 20/4/8 18/4/8
f 10/4/9 18/4/9 11/4/9
f 21/4/10 23/5/10 22/6/10
f 24/4/10 26/5/10 25/6/10
f 1/1/1 3/7/1 4/2/1
f 14/4/11 12/4/11 10/4/11
f 10/4/12 13/4/12 16/4/12
f 15/4/13 14/4/13 10/4/13
f 7/4/3 5/4/3 12/4/3
f 8/4/4 7/4/4 14/4/4
f 9/4/5 8/4/5 15/4/5
f 5/4/6 4/4/6 11/4/6
f 3/4/14 5/4/14 7/4/14
f 8/4/15 9/4/15 6/4/15
f 3/4/16 7/4/16 8/4/16
f 17/4/8 19/4/8 20/4/8
f 10/4/9 17/4/9 18/4/9
f 20/4/1 26/4/1 23/4/1
f 20/4/1 19/4/1 26/4/1
`)));

    </script>
</body>

</html>
