<!--- Takes a obj and converts it to a more readable format. Make sure model is triangulated --->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        function objtodad(obj) {
            let lines = obj.split('\n');
            let output = '';

            for (let line of lines) {
                const split = line.split(' ')
                let instruction = split[0];
                split.shift()
                let data = split.join(' ');

                if (instruction == 'v') {
                    output += data.split(' ').join(',');
                }

                if (instruction == 'f') {
                    if (output.indexOf(':') == -1)
                        output += ':';
                    output += data.split(' ').map(input => input.split('/')[0]).join(',') + ';';
                }
            }
            return output;
        }

        function bintogeometry(obj) {
            const verts = stringToCharCodeArray(obj.split('ÿ')[0]); //charcode 255
            const indices = stringToCharCodeArray(obj.split('ÿ')[1]).map(str => str * 254); //multiply by 254 for indices

            return { verts, indices };
        }

        const convert = value => (value + 127.5) / 255;

        function objtobin(obj) {
            let lines = obj.split('\n');
            let output = '';
            let colors = [];

            for (let line of lines) {
                const split = line.split(' ')
                let instruction = split[0];
                let currentColor = '#ff0000';
                split.shift()
                let data = split.join(' ');

                if (instruction == 'v') {
                    output += data.split(' ').map(s => String.fromCharCode(+s * 256 + 128).replace('\\', '\\\\').replace('\0', '\\0')).join``;
                }

                if (instruction == 'f') {
                    if (output.indexOf('ÿ') == -1)
                        output += 'ÿ';
                    output += data.split(' ').map(input => String.fromCharCode(+(input.split('/')[0])).replace('\\', '\\\\').replace('\0', '\\0')).join(``);
                    output += String.fromCharCode(colors.length - 1);
                }

                if (instruction == 'usemtl') {
                    color = data;
                    colors.push(color);
                }
            }
            console.log(colors);
            return output + 'ÿ' + colors.join``;
        }

        function hexToRgbArray(hex) {
            // Remove the "#" symbol if it exists
            hex = hex.replace(/^#/, '');

            // Parse the hex values for red, green, and blue
            const r = parseInt(hex.slice(0, 2), 16) / 255;
            const g = parseInt(hex.slice(2, 4), 16) / 255;
            const b = parseInt(hex.slice(4, 6), 16) / 255;

            // Return the RGB color as an array with values in the [0, 1] range
            return [r, g, b];
        }

        function parseOBJ(objString) {
            const parsedObjects = {};
            let currentObject = null;
            let currentColor = '#deadbeef';
            let currentColorCount = 0;
            let indexOffset = 0;

            const lines = objString.split('\n');

            for (let line of lines) {
                const parts = line.trim().split(/\s+/);

                if (parts[0] === 'o' && parts[1]) {
                    // Start of a new object
                    if (currentObject !== null) {
                        // If there's data in the current object, push it to the array
                        indexOffset += currentObject.data.vertices.length / 3;
                        parsedObjects[currentObject.name] = currentObject.data;
                    }
                    // Create a new object with an empty data object
                    currentObject = { name: parts[1], data: { vertices: [], normals: [], indices: [], colors: [] } };
                } else if (parts[0] === 'v') {
                    // Vertex
                    currentObject.data.vertices.push(Math.trunc(parseFloat(parts[1]) * 100), Math.trunc(parseFloat(parts[2]) * 100), Math.trunc(parseFloat(parts[3]) * 100));
                }
                else if (parts[0] === 'f') {
                    // Face
                    for (let i = 1; i < 4; i++) {
                        const faceData = parts[i].split('/');
                        currentObject.data.indices.push(parseInt(faceData[0]) - 1 - indexOffset); // OBJ indices start from 1!

                    }
                    currentColorCount++;
                } else if (parts[0] === 'usemtl') {
                    if (currentColorCount != 0)
                        currentObject.data.colors.push([currentColor, currentColorCount]);
                    currentColor = parts[1];
                    currentColorCount = 0;
                } 
            }

            if (currentColorCount != 0)
                    currentObject.data.colors.push([currentColor, currentColorCount]);

            if (currentObject !== null) {
                indexOffset += currentObject.data.vertices.length / 3;
                parsedObjects[currentObject.name] = currentObject.data;
            }

            return parsedObjects;
        }


        // Example usage:
        // const objString = '...'; // Your OBJ file content as a string
        // const { vertices, normals, indices } = parseOBJ(objString);


        const stringToCharCodeArray = s => [...s].map(c => c.charCodeAt() / 254);//note that it returns values between 0 and 1
        const charCodeArrayToString = a => a.map(i => String.fromCharCode(i * 254 | 0)).join``;

        console.log(stringToCharCodeArray(charCodeArrayToString([.3, .5, .8, .9])))

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.click();

            URL.revokeObjectURL(url);
        }


        // Example usage:
        // const plyString = '...'; // Your PLY file content as a string
        // const { vertices, normals, colors, indices, vertexFormat } = parsePLY(plyString);


        console.log(JSON.stringify(parseOBJ(`# Blender 4.2.0
# www.blender.org
mtllib elevator.mtl
o Cube
v 0.000000 2.982176 2.664311
v 0.000000 3.098224 2.992543
v 0.000000 0.158024 2.664311
v 0.000000 0.041976 2.992543
v 0.000000 3.040200 2.544170
v -0.142128 0.200500 2.686299
v -0.142128 2.939700 2.686299
v 0.000000 0.100000 2.544170
v -1.272085 3.040200 1.272085
v -1.332156 2.982176 1.332156
v -1.496271 3.098224 1.496271
v -1.414214 2.939700 1.414214
v -1.414214 0.200500 1.414214
v -1.332156 0.158024 1.332156
v -1.496271 0.041976 1.496271
v -1.272085 0.100000 1.272085
v 0.000000 0.158024 0.000000
v 0.000000 3.098224 0.000000
v 0.000000 3.040200 0.000000
vn 0.3988 -0.8258 -0.3988
vn -0.1529 -0.0000 -0.9882
vn -0.9071 -0.0000 0.4210
vn -0.5706 -0.5907 0.5706
vn 0.2430 0.9391 -0.2430
vn 0.1273 -0.9837 -0.1273
vn 0.3988 0.8258 -0.3988
vn -0.5706 0.5907 0.5706
vn -0.0000 1.0000 -0.0000
vn 0.2431 -0.9391 -0.2430
vn 0.1273 0.9837 -0.1273
vn -0.0000 -1.0000 -0.0000
vn 0.2430 -0.9391 -0.2431
vt 0.875000 0.750000
vt 0.875000 0.625000
vt 0.625000 0.000000
vt 0.375000 0.000000
vt 0.625000 0.125000
vt 0.375000 0.125000
vt 0.125000 0.750000
vt 0.125000 0.625000
vt 0.000000 0.000000
s 0
usemtl Material
f 5/1/1 10/2/1 9/2/1
f 7/3/2 3/4/2 6/4/2
f 6/4/3 2/3/3 7/3/3
f 7/3/4 11/5/4 12/5/4
f 6/4/5 14/6/5 13/6/5
f 8/7/6 15/8/6 16/8/6
f 8/7/7 14/8/7 3/7/7
f 6/4/8 15/6/8 4/4/8
f 18/9/9 11/9/9 2/9/9
f 7/3/10 10/5/10 1/3/10
f 5/1/11 11/2/11 2/1/11
f 19/9/9 9/9/9 5/9/9
f 14/9/12 17/9/12 3/9/12
f 5/1/1 1/1/1 10/2/1
f 7/3/2 1/3/2 3/4/2
f 6/4/3 4/4/3 2/3/3
f 7/3/4 2/3/4 11/5/4
f 6/4/5 3/4/5 14/6/5
f 8/7/6 4/7/6 15/8/6
f 8/7/7 16/8/7 14/8/7
f 6/4/8 13/6/8 15/6/8
f 7/3/13 12/5/13 10/5/13
f 5/1/11 9/2/11 11/2/11
`)));

    </script>
</body>

</html>
